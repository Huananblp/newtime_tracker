// server.js - Time Tracker with Fixed Status Checking
const express = require('express');
const cors = require('cors');
const { GoogleSpreadsheet } = require('google-spreadsheet');
const { JWT } = require('google-auth-library');
const path = require('path');
const cron = require('node-cron');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

// ========== Enhanced Configuration ==========
const CONFIG = {
  GOOGLE_SHEETS: {
    SPREADSHEET_ID: process.env.GOOGLE_SPREADSHEET_ID,
    PRIVATE_KEY: process.env.GOOGLE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
    CLIENT_EMAIL: process.env.GOOGLE_CLIENT_EMAIL,
  },
  TELEGRAM: {
    BOT_TOKEN: process.env.TELEGRAM_BOT_TOKEN,
    CHAT_ID: process.env.TELEGRAM_CHAT_ID
  },
  SHEETS: {
    MAIN: 'MAIN',
    EMPLOYEES: 'EMPLOYEES',
    ON_WORK: 'ON WORK'
  },
  RENDER: {
    SERVICE_URL: process.env.RENDER_SERVICE_URL || `https://${process.env.RENDER_EXTERNAL_HOSTNAME}` || 'http://localhost:3000',
    KEEP_ALIVE_ENABLED: process.env.KEEP_ALIVE_ENABLED === 'true',
    GSA_WEBHOOK_SECRET: process.env.GSA_WEBHOOK_SECRET || 'your-secret-key'
  },
  TIMEZONE: 'Asia/Bangkok'
};

// ========== Middleware ==========
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Security middleware ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö webhook
app.use('/api/webhook', (req, res, next) => {
  const providedSecret = req.headers['x-webhook-secret'] || req.query.secret;
  if (providedSecret !== CONFIG.RENDER.GSA_WEBHOOK_SECRET) {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  next();
});

// Serve static files
app.use(express.static('public'));

// ========== Keep-Alive Service ==========
class KeepAliveService {
  constructor() {
    this.isEnabled = CONFIG.RENDER.KEEP_ALIVE_ENABLED;
    this.serviceUrl = CONFIG.RENDER.SERVICE_URL;
    this.startTime = new Date();
    this.pingCount = 0;
    this.errorCount = 0;
  }

  init() {
    if (!this.isEnabled) {
      console.log('üî¥ Keep-Alive disabled');
      return;
    }

    console.log('üü¢ Keep-Alive service started');
    console.log(`üìç Service URL: ${this.serviceUrl}`);

    // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: 05:00-10:00 ‡πÅ‡∏•‡∏∞ 15:00-20:00 (‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢)
    // ‡∏õ‡∏¥‡∏á‡∏ó‡∏∏‡∏Å 10 ‡∏ô‡∏≤‡∏ó‡∏µ
    cron.schedule('*/10 * * * *', () => {
      this.checkAndPing();
    }, {
      scheduled: true,
      timezone: CONFIG.TIMEZONE
    });

    // Ping ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    setTimeout(() => this.ping(), 5000);
  }

  checkAndPing() {
    const now = new Date();
    const hour = now.getHours();
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏´‡∏°
    const isWorkingHour = (hour >= 5 && hour < 10) || (hour >= 15 && hour < 20);
    
    if (isWorkingHour) {
      this.ping();
    } else {
      console.log(`üò¥ Outside working hours (${hour}:00), skipping ping`);
    }
  }

  async ping() {
    try {
      const response = await fetch(`${this.serviceUrl}/api/ping`, {
        method: 'GET',
        headers: {
          'User-Agent': 'KeepAlive-Service/1.0'
        }
      });

      this.pingCount++;
      
      if (response.ok) {
        console.log(`‚úÖ Keep-Alive ping #${this.pingCount} successful`);
        this.errorCount = 0; // Reset error count on success
      } else {
        throw new Error(`HTTP ${response.status}`);
      }
      
    } catch (error) {
      this.errorCount++;
      console.log(`‚ùå Keep-Alive ping #${this.pingCount} failed:`, error.message);
      
      // ‡∏´‡∏≤‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á ping ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á 1 ‡∏ô‡∏≤‡∏ó‡∏µ
      if (this.errorCount >= 5) {
        console.log('üîÑ Too many errors, will retry in 1 minute');
        setTimeout(() => this.ping(), 60000);
      }
    }
  }

  getStats() {
    const uptime = Math.floor((Date.now() - this.startTime.getTime()) / 1000);
    return {
      enabled: this.isEnabled,
      uptime: uptime,
      pingCount: this.pingCount,
      errorCount: this.errorCount,
      lastPing: new Date().toISOString()
    };
  }
}

// ========== Google Sheets Service ==========
class GoogleSheetsService {
  constructor() {
    this.doc = null;
    this.isInitialized = false;
  }

  async initialize() {
    if (this.isInitialized) return;

    try {
      const serviceAccountAuth = new JWT({
        email: CONFIG.GOOGLE_SHEETS.CLIENT_EMAIL,
        key: CONFIG.GOOGLE_SHEETS.PRIVATE_KEY,
        scopes: ['https://www.googleapis.com/auth/spreadsheets']
      });

      this.doc = new GoogleSpreadsheet(CONFIG.GOOGLE_SHEETS.SPREADSHEET_ID, serviceAccountAuth);
      await this.doc.loadInfo();
      
      console.log(`‚úÖ Connected to Google Sheets: ${this.doc.title}`);
      this.isInitialized = true;
      
    } catch (error) {
      console.error('‚ùå Failed to initialize Google Sheets:', error);
      throw error;
    }
  }

  async getSheet(sheetName) {
    if (!this.isInitialized) {
      await this.initialize();
    }
    
    const sheet = this.doc.sheetsByTitle[sheetName];
    if (!sheet) {
      throw new Error(`Sheet ${sheetName} not found`);
    }
    
    return sheet;
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ä‡∏∑‡πà‡∏≠ - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà
  normalizeEmployeeName(name) {
    if (!name) return '';
    
    return name.toString()
      .trim()
      .replace(/\s+/g, ' ') // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà whitespace ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏î‡πâ‡∏ß‡∏¢ space ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      .toLowerCase(); // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
  }

  isNameMatch(inputName, compareName) {
    if (!inputName || !compareName) return false;
    
    const normalizedInput = this.normalizeEmployeeName(inputName);
    const normalizedCompare = this.normalizeEmployeeName(compareName);
    
    // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á‡πÜ
    return normalizedInput === normalizedCompare ||
           normalizedInput.includes(normalizedCompare) ||
           normalizedCompare.includes(normalizedInput);
  }

  async getEmployees() {
    try {
      const sheet = await this.getSheet(CONFIG.SHEETS.EMPLOYEES);
      const rows = await sheet.getRows();
      
      const employees = rows.map(row => row.get('‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•')).filter(name => name);
      return employees;
      
    } catch (error) {
      console.error('Error getting employees:', error);
      return [];
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà
  async getEmployeeStatus(employeeName) {
    try {
      const sheet = await this.getSheet(CONFIG.SHEETS.ON_WORK);
      const rows = await sheet.getRows();
      
      console.log(`üîç Checking status for: "${employeeName}"`);
      console.log(`üìä Total rows in ON_WORK: ${rows.length}`);
      
      if (rows.length === 0) {
        console.log('üìã ON_WORK sheet is empty');
        return { isOnWork: false, workRecord: null };
      }
      
      // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
      const workRecord = rows.find(row => {
        const systemName = row.get('‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
        const employeeName2 = row.get('‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
        
        const isMatch = this.isNameMatch(employeeName, systemName) || 
                       this.isNameMatch(employeeName, employeeName2);
        
        if (isMatch) {
          console.log(`‚úÖ Found match: "${employeeName}" ‚Üî "${systemName || employeeName2}"`);
        }
        
        return isMatch;
      });
      
      if (workRecord) {
        // ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ñ‡∏ß‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        let mainRowIndex = null;
        
        const rowRef1 = workRecord.get('‡πÅ‡∏ñ‡∏ß‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á');
        const rowRef2 = workRecord.get('‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ôMain');
        
        if (rowRef1 && !isNaN(parseInt(rowRef1))) {
          mainRowIndex = parseInt(rowRef1);
        } else if (rowRef2 && !isNaN(parseInt(rowRef2))) {
          mainRowIndex = parseInt(rowRef2);
        }
        
        console.log(`‚úÖ Employee "${employeeName}" is currently working`);
        
        return {
          isOnWork: true,
          workRecord: {
            row: workRecord,
            mainRowIndex: mainRowIndex,
            clockIn: workRecord.get('‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤'),
            systemName: workRecord.get('‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'),
            employeeName: workRecord.get('‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')
          }
        };
      } else {
        console.log(`‚ùå Employee "${employeeName}" is not currently working`);
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug
        const availableNames = rows.map(row => ({
          systemName: row.get('‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'),
          employeeName: row.get('‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')
        })).filter(emp => emp.systemName || emp.employeeName);
        
        console.log('üìã Currently working employees:', availableNames);
        
        return { isOnWork: false, workRecord: null };
      }
      
    } catch (error) {
      console.error('‚ùå Error checking employee status:', error);
      return { isOnWork: false, workRecord: null };
    }
  }

  // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getEmployeeStatus ‡πÅ‡∏ó‡∏ô
  async isEmployeeOnWork(employeeName) {
    const status = await this.getEmployeeStatus(employeeName);
    return status.isOnWork;
  }

  async getEmployeeWorkRecord(employeeName) {
    const status = await this.getEmployeeStatus(employeeName);
    return status.workRecord;
  }

  async clockIn(data) {
    try {
      const { employee, userinfo, lat, lon, line_name, line_picture } = data;
      
      console.log(`‚è∞ Clock In request for: "${employee}"`);
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
      const employeeStatus = await this.getEmployeeStatus(employee);
      
      if (employeeStatus.isOnWork) {
        console.log(`‚ùå Employee "${employee}" is already clocked in`);
        return {
          success: false,
          message: '‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô',
          employee,
          currentStatus: 'clocked_in',
          clockInTime: employeeStatus.workRecord?.clockIn
        };
      }

      const timestamp = new Date();
      const location = `${lat},${lon}`;
      
      console.log(`‚úÖ Proceeding with clock in for "${employee}"`);
      
      // Add to MAIN sheet
      const mainSheet = await this.getSheet(CONFIG.SHEETS.MAIN);
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà
      const newRow = await mainSheet.addRow([
        employee,           // ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        line_name,          // ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏•‡∏ô‡πå
        `=IMAGE("${line_picture}")`, // ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
        timestamp,          // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤
        userinfo || '',     // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
        '',                 // ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å
        `${lat},${lon}`,    // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏Ç‡πâ‡∏≤
        location,           // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏Ç‡πâ‡∏≤
        '',                 // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏≠‡∏≠‡∏Å
        '',                 // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≠‡∏Å
        ''                  // ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
      ]);

      // ‡∏î‡∏∂‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°
      const mainRowIndex = newRow.rowNumber;
      console.log(`‚úÖ Added to MAIN sheet at row: ${mainRowIndex}`);

      // Add to ON_WORK sheet ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ñ‡∏ß‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
      const onWorkSheet = await this.getSheet(CONFIG.SHEETS.ON_WORK);
      await onWorkSheet.addRow([
        timestamp,          // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        employee,           // ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        timestamp,          // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤
        '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô',           // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        userinfo || '',     // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
        `${lat},${lon}`,    // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏Ç‡πâ‡∏≤
        location,           // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏Ç‡πâ‡∏≤
        mainRowIndex,       // ‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ôMain
        line_name,          // ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏•‡∏ô‡πå
        line_picture,       // ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
        mainRowIndex,       // ‡πÅ‡∏ñ‡∏ß‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
        employee            // ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
      ]);

      console.log(`‚úÖ Clock In successful: ${employee} at ${this.formatTime(timestamp)}, Main row: ${mainRowIndex}`);

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å GSA webhook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á Telegram
      this.triggerMapGeneration('clockin', {
        employee, lat, lon, line_name, userinfo, timestamp
      });

      return {
        success: true,
        message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        employee,
        time: this.formatTime(timestamp),
        currentStatus: 'clocked_in'
      };

    } catch (error) {
      console.error('‚ùå Clock in error:', error);
      return {
        success: false,
        message: `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`,
        employee: data.employee
      };
    }
  }

  async clockOut(data) {
    try {
      const { employee, lat, lon, line_name } = data;
      
      console.log(`‚è∞ Clock Out request for: "${employee}"`);
      console.log(`üìç Location: ${lat}, ${lon}`);
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
      const employeeStatus = await this.getEmployeeStatus(employee);
      
      if (!employeeStatus.isOnWork) {
        console.log(`‚ùå Employee "${employee}" is not clocked in`);
        
        // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        const onWorkSheet = await this.getSheet(CONFIG.SHEETS.ON_WORK);
        const rows = await onWorkSheet.getRows();
        
        const suggestions = rows
          .map(row => ({
            systemName: row.get('‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'),
            employeeName: row.get('‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')
          }))
          .filter(emp => emp.systemName || emp.employeeName)
          .filter(emp => 
            this.isNameMatch(employee, emp.systemName) ||
            this.isNameMatch(employee, emp.employeeName)
          );
        
        let message = '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        
        if (suggestions.length > 0) {
          const suggestedNames = suggestions.map(s => s.systemName || s.employeeName);
          message = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á: ${suggestedNames.join(', ')}`;
        }
        
        return {
          success: false,
          message: message,
          employee,
          currentStatus: 'not_clocked_in',
          suggestions: suggestions.length > 0 ? suggestions : undefined
        };
      }

      const timestamp = new Date();
      const workRecord = employeeStatus.workRecord;
      
      // ‡∏î‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å work record
      const clockInTime = workRecord.clockIn;
      console.log(`‚è∞ Clock in time: ${clockInTime}`);
      
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
      let hoursWorked = 0;
      if (clockInTime) {
        const clockInDate = new Date(clockInTime);
        hoursWorked = (timestamp - clockInDate) / (1000 * 60 * 60);
        console.log(`‚è±Ô∏è Hours worked: ${hoursWorked.toFixed(2)}`);
      }
      
      const location = `${lat},${lon}`;

      console.log(`‚úÖ Proceeding with clock out for "${employee}"`);
      
      // Update MAIN sheet
      console.log(`üìù Updating MAIN sheet...`);
      const mainSheet = await this.getSheet(CONFIG.SHEETS.MAIN);
      const rows = await mainSheet.getRows();
      
      console.log(`üìä Total rows in MAIN: ${rows.length}`);
      console.log(`üéØ Target row index: ${workRecord.mainRowIndex}`);
      
      let mainRow = null;
      
      // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡πÉ‡∏ä‡πâ index ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      if (workRecord.mainRowIndex && workRecord.mainRowIndex > 1) {
        const targetIndex = workRecord.mainRowIndex - 2;
        
        if (targetIndex >= 0 && targetIndex < rows.length) {
          const candidateRow = rows[targetIndex];
          const candidateEmployee = candidateRow.get('‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢
          if (this.isNameMatch(employee, candidateEmployee)) {
            mainRow = candidateRow;
            console.log(`‚úÖ Found main row by index: ${targetIndex} (row ${workRecord.mainRowIndex})`);
          } else {
            console.log(`‚ö†Ô∏è Row index found but employee name mismatch: "${candidateEmployee}" vs "${employee}"`);
          }
        } else {
          console.log(`‚ö†Ô∏è Row index out of range: ${targetIndex} (total rows: ${rows.length})`);
        }
      }
      
      // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡∏ñ‡πâ‡∏≤‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏£‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
      if (!mainRow) {
        console.log('üîç Searching by employee name and conditions...');
        
        const candidateRows = rows.filter(row => {
          const rowEmployee = row.get('‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
          const rowClockOut = row.get('‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å');
          
          return this.isNameMatch(employee, rowEmployee) && !rowClockOut;
        });
        
        console.log(`Found ${candidateRows.length} candidate rows without clock out`);
        
        if (candidateRows.length === 1) {
          mainRow = candidateRows[0];
          console.log(`‚úÖ Found unique candidate row`);
        } else if (candidateRows.length > 1) {
          // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
          let closestRow = null;
          let minTimeDiff = Infinity;
          
          candidateRows.forEach((row, index) => {
            const rowClockIn = row.get('‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤');
            if (rowClockIn && clockInTime) {
              const timeDiff = Math.abs(new Date(rowClockIn) - new Date(clockInTime));
              console.log(`Candidate ${index}: time diff = ${timeDiff}ms`);
              if (timeDiff < minTimeDiff) {
                minTimeDiff = timeDiff;
                closestRow = row;
              }
            }
          });
          
          if (closestRow && minTimeDiff < 300000) { // ‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ
            mainRow = closestRow;
            console.log(`‚úÖ Found closest matching row (time diff: ${minTimeDiff}ms)`);
          } else {
            console.log(`‚ùå No close time match found (min diff: ${minTimeDiff}ms)`);
          }
        }
      }
      
      // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 3: ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
      if (!mainRow) {
        console.log('üîç Searching for latest row of this employee...');
        
        for (let i = rows.length - 1; i >= 0; i--) {
          const row = rows[i];
          const rowEmployee = row.get('‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
          const rowClockOut = row.get('‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å');
          
          if (this.isNameMatch(employee, rowEmployee) && !rowClockOut) {
            mainRow = row;
            console.log(`‚úÖ Found latest uncompleted row at index: ${i}`);
            break;
          }
        }
      }
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏´‡∏≤‡πÄ‡∏à‡∏≠‡πÑ‡∏´‡∏°
      if (!mainRow) {
        console.log('‚ùå Cannot find main row to update');
        
        return {
          success: false,
          message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö',
          employee
        };
      }
      
      console.log('‚úÖ Found main row, updating...');
      
      // Update main row with error handling
      try {
        mainRow.set('‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å', timestamp);
        mainRow.set('‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏≠‡∏≠‡∏Å', `${lat},${lon}`);
        mainRow.set('‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≠‡∏Å', location);
        mainRow.set('‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', hoursWorked.toFixed(2));
        await mainRow.save();
        console.log('‚úÖ Main row updated successfully');
      } catch (updateError) {
        console.error('‚ùå Error updating main row:', updateError);
        throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + updateError.message);
      }

      // Remove from ON_WORK sheet
      try {
        await workRecord.row.delete();
        console.log('‚úÖ Removed from ON_WORK sheet');
      } catch (deleteError) {
        console.error('‚ùå Error deleting from ON_WORK:', deleteError);
        // ‡πÑ‡∏°‡πà throw error ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß
      }

      console.log(`‚úÖ Clock Out successful: ${employee} at ${this.formatTime(timestamp)} (${hoursWorked.toFixed(2)} hours)`);

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å GSA webhook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á Telegram
      try {
        this.triggerMapGeneration('clockout', {
          employee, lat, lon, line_name, timestamp, hoursWorked
        });
      } catch (webhookError) {
        console.error('‚ö†Ô∏è Webhook error (non-critical):', webhookError);
      }

      return {
        success: true,
        message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        employee,
        time: this.formatTime(timestamp),
        hours: hoursWorked.toFixed(2),
        currentStatus: 'clocked_out'
      };

    } catch (error) {
      console.error('‚ùå Clock out error:', error);
      
      return {
        success: false,
        message: `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`,
        employee: data.employee
      };
    }
  }

  async triggerMapGeneration(action, data) {
    try {
      const gsaWebhookUrl = process.env.GSA_MAP_WEBHOOK_URL;
      if (!gsaWebhookUrl) {
        console.log('‚ö†Ô∏è GSA webhook URL not configured');
        return;
      }

      const payload = {
        action,
        data,
        timestamp: new Date().toISOString()
      };

      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
      await fetch(gsaWebhookUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Webhook-Secret': CONFIG.RENDER.GSA_WEBHOOK_SECRET
        },
        body: JSON.stringify(payload)
      });

      console.log(`üìç Map generation triggered for ${action}: ${data.employee}`);
      
    } catch (error) {
      console.error('Error triggering map generation:', error);
    }
  }

  formatTime(date) {
    return date.toLocaleTimeString('th-TH', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      timeZone: CONFIG.TIMEZONE
    }) + ' ‡∏ô.';
  }
}

// ========== Initialize Services ==========
const sheetsService = new GoogleSheetsService();
const keepAliveService = new KeepAliveService();

// ========== Routes ==========

// Home page
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// Health check ‡πÅ‡∏•‡∏∞ ping endpoint
app.get('/api/health', (req, res) => {
  res.json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    keepAlive: keepAliveService.getStats(),
    environment: process.env.NODE_ENV || 'development'
  });
});

// Ping endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö keep-alive
app.get('/api/ping', (req, res) => {
  res.json({
    status: 'pong',
    timestamp: new Date().toISOString(),
    uptime: process.uptime()
  });
});

// Webhook endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö ping ‡∏à‡∏≤‡∏Å GSA
app.post('/api/webhook/ping', (req, res) => {
  console.log('üì® Received ping from GSA');
  res.json({
    status: 'received',
    timestamp: new Date().toISOString()
  });
});

// Get employees
app.post('/api/employees', async (req, res) => {
  try {
    const employees = await sheetsService.getEmployees();
    res.json({
      success: true,
      data: employees
    });
  } catch (error) {
    console.error('API Error - employees:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to get employees'
    });
  }
});

// Clock in
app.post('/api/clockin', async (req, res) => {
  try {
    const { employee, userinfo, lat, lon, line_name, line_picture } = req.body;
    
    if (!employee || !lat || !lon) {
      return res.status(400).json({
        success: false,
        error: 'Missing required fields'
      });
    }

    const result = await sheetsService.clockIn({
      employee, userinfo, lat, lon, line_name, line_picture
    });

    res.json(result);
    
  } catch (error) {
    console.error('API Error - clockin:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to clock in'
    });
  }
});

// Clock out
app.post('/api/clockout', async (req, res) => {
  try {
    const { employee, lat, lon, line_name } = req.body;
    
    if (!employee || !lat || !lon) {
      return res.status(400).json({
        success: false,
        error: 'Missing required fields'
      });
    }

    const result = await sheetsService.clockOut({
      employee, lat, lon, line_name
    });

    res.json(result);
    
  } catch (error) {
    console.error('API Error - clockout:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to clock out'
    });
  }
});

// API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà
app.post('/api/check-status', async (req, res) => {
  try {
    const { employee } = req.body;
    
    if (!employee) {
      return res.status(400).json({
        success: false,
        error: 'Missing employee name'
      });
    }

    // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß
    const employeeStatus = await sheetsService.getEmployeeStatus(employee);

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ON_WORK ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const onWorkSheet = await sheetsService.getSheet(CONFIG.SHEETS.ON_WORK);
    const rows = await onWorkSheet.getRows();
    
    const currentEmployees = rows.map(row => ({
      systemName: row.get('‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'),
      employeeName: row.get('‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'),
      clockIn: row.get('‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤'),
      mainRowIndex: row.get('‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ôMain') || row.get('‡πÅ‡∏ñ‡∏ß‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á')
    }));

    res.json({
      success: true,
      data: {
        employee: employee,
        isOnWork: employeeStatus.isOnWork,
        hasWorkRecord: !!employeeStatus.workRecord,
        workRecord: employeeStatus.workRecord ? {
          clockIn: employeeStatus.workRecord.clockIn,
          mainRowIndex: employeeStatus.workRecord.mainRowIndex
        } : null,
        allCurrentEmployees: currentEmployees,
        suggestions: currentEmployees
          .filter(emp => 
            sheetsService.isNameMatch(employee, emp.systemName) ||
            sheetsService.isNameMatch(employee, emp.employeeName)
          )
          .map(emp => emp.systemName || emp.employeeName)
      }
    });

  } catch (error) {
    console.error('API Error - check-status:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to check status'
    });
  }
});

// API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π debug info - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà
app.post('/api/debug-info', async (req, res) => {
  try {
    const { employee } = req.body;

    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å MAIN sheet
    const mainSheet = await sheetsService.getSheet(CONFIG.SHEETS.MAIN);
    const mainRows = await mainSheet.getRows();
    
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å ON_WORK sheet
    const onWorkSheet = await sheetsService.getSheet(CONFIG.SHEETS.ON_WORK);
    const onWorkRows = await onWorkSheet.getRows();

    // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
    const relatedMainRows = mainRows
      .filter(row => {
        const rowEmployee = row.get('‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
        return sheetsService.isNameMatch(employee, rowEmployee);
      })
      .slice(-5) // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà 5 ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      .map(row => ({
        employee: row.get('‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'),
        clockIn: row.get('‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤'),
        clockOut: row.get('‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å'),
        rowNumber: row.rowNumber
      }));

    const relatedOnWorkRows = onWorkRows
      .filter(row => {
        const systemName = row.get('‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
        const employeeName2 = row.get('‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
        return sheetsService.isNameMatch(employee, systemName) ||
               sheetsService.isNameMatch(employee, employeeName2);
      })
      .map(row => ({
        systemName: row.get('‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'),
        employeeName: row.get('‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'),
        clockIn: row.get('‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤'),
        mainRowIndex: row.get('‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ôMain') || row.get('‡πÅ‡∏ñ‡∏ß‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á'),
        rowNumber: row.rowNumber
      }));

    res.json({
      success: true,
      data: {
        searchTerm: employee,
        mainSheetData: relatedMainRows,
        onWorkSheetData: relatedOnWorkRows,
        totalMainRows: mainRows.length,
        totalOnWorkRows: onWorkRows.length,
        headers: {
          main: await mainSheet.getHeaderValues(),
          onWork: await onWorkSheet.getHeaderValues()
        }
      }
    });

  } catch (error) {
    console.error('API Error - debug-info:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to get debug info'
    });
  }
});

// ========== Error Handling ==========
app.use((error, req, res, next) => {
  console.error('Global error handler:', error);
  res.status(500).json({
    success: false,
    error: 'Internal server error'
  });
});

app.use((req, res) => {
  res.status(404).json({
    success: false,
    error: 'Not found'
  });
});

// ========== Start Server ==========
async function startServer() {
  try {
    console.log('üöÄ Starting Time Tracker Server...');
    console.log(`üåç Environment: ${process.env.NODE_ENV || 'development'}`);
    console.log('üìä Initializing Google Sheets service...');
    
    await sheetsService.initialize();
    
    app.listen(PORT, () => {
      console.log(`‚úÖ Server running on port ${PORT}`);
      console.log(`üìä Google Sheets connected: ${CONFIG.GOOGLE_SHEETS.SPREADSHEET_ID}`);
      console.log(`üåê Service URL: ${CONFIG.RENDER.SERVICE_URL}`);
      
      // ‡πÄ‡∏£‡∏¥‡πà‡∏° Keep-Alive service
      keepAliveService.init();
    });
    
  } catch (error) {
    console.error('‚ùå Failed to start server:', error);
    process.exit(1);
  }
}

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('SIGTERM received, shutting down gracefully');
  process.exit(0);
});

process.on('SIGINT', () => {
  console.log('SIGINT received, shutting down gracefully');
  process.exit(0);
});

startServer();