<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://www.huana-nbp.go.th/index/add_file/P0D284NMon35557.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- ****** Auto Complete ********* -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/ui-lightness/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <title>ระบบลงเวลาออนไลน์ อบต.ข่าใหญ่</title>

    <!-- ****** Style CSS ********* -->
    <style>
        input#employee {
            width: 282px;
            height: 60px;
            background-color: brown;
            color: yellow;
            margin-block-start: 5px;
            border-radius: 36px;
            font-size: 20px;
        }

        div#showtxt {
            font-size: 27px;
            margin-top: 20px;
        }

        @font-face {
            font-family: 'Digital dream Fat';
            src: url('https://semicon.github.io/fonts/DigitaldreamFat.woff2') format('woff2'),
                 url('https://semicon.github.io/fonts/DigitaldreamFat.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        @import url('https://fonts.googleapis.com/css2?family=K2D&family=Kanit&family=Sriracha&display=swap');

        * {
            margin: 0px;
            padding: 0px;
            box-sizing: border-box;
            font-family: 'K2D', sans-serif;
        }        body {
            font-family: 'Kanit', sans-serif;
            color: #444;
            background-color: white;
            padding: 20px;
            border: 2px solid white;
            box-shadow: 0px 8px 10px rgba(0, 0, 0, 0.5);
            font-size: 1.05rem;
            min-height: 100vh;
            display: flex;
            justify-content: center;            align-items: center;
            background-color: #92a8d1;
            background: url("https://images.unsplash.com/photo-1557804506-669a67965ba0?ixlib=rb-4.0.3");
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: cover;
        }

        input#employee {
            font-family: 'Kanit', sans-serif;
            width: 282px;
            height: 60px;
            background-color: brown;
            color: yellow;
            margin-block-start: 5px;
            border-radius: 36px;
            font-size: 20px;
        }

        .site-logo {
            content: url("https://www.huana-nbp.go.th/index/add_file/P0D284NMon35557.png");
            display: inline-block;
            margin-top: 20px;
            width: auto;
            height: 100px;
        }

        .msgBg {
            background-color: transparent;
        }

        .wrapper {
            background: rgba(221, 255, 255, 0.7);
            width: 350px;
            padding: 20px;
            border: 1px solid #999;
            border-radius: 5px;
            box-shadow: 0px 15px 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /** #### digital clock #### **/
        .clock {
            font-family: Digital dream Fat;
            font-size: 28px;
            color: #00f6fa;
            letter-spacing: 3px;
            text-shadow: 1px 1px 2px teal, 0 0 25px green, 0 0 5px #00fbff;
            min-width: 98%;
            background: #444;
            padding: 5px 0px 5px 10px;
            display: inline-block;
            border: 3px solid #ccc;
            border-radius: 2px;
            outline-style: solid;
            outline-color: #999;
        }

        /* ===== ไฟสถานะมุมขวาบน ===== */
        .status-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .status-online {
            background: linear-gradient(45deg, #28a745, #20c997);
            box-shadow: 
                0 0 20px rgba(40, 167, 69, 0.6),
                0 0 40px rgba(40, 167, 69, 0.4),
                inset 0 1px 3px rgba(255, 255, 255, 0.3);
            animation: smooth-pulse-green 2s ease-in-out infinite;
        }

        .status-offline {
            background: linear-gradient(45deg, #dc3545, #e74c3c);
            box-shadow: 
                0 0 20px rgba(220, 53, 69, 0.6),
                0 0 40px rgba(220, 53, 69, 0.4),
                inset 0 1px 3px rgba(255, 255, 255, 0.3);
            animation: smooth-pulse-red 2s ease-in-out infinite;
        }

        .status-connecting {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            box-shadow: 
                0 0 20px rgba(255, 193, 7, 0.6),
                0 0 40px rgba(255, 193, 7, 0.4),
                inset 0 1px 3px rgba(255, 255, 255, 0.3);
            animation: smooth-pulse-yellow 1s ease-in-out infinite;
        }

        /* สมูท animations */
        @keyframes smooth-pulse-green {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 
                    0 0 20px rgba(40, 167, 69, 0.6),
                    0 0 40px rgba(40, 167, 69, 0.4),
                    inset 0 1px 3px rgba(255, 255, 255, 0.3);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.1);
                box-shadow: 
                    0 0 30px rgba(40, 167, 69, 0.8),
                    0 0 60px rgba(40, 167, 69, 0.6),
                    inset 0 1px 3px rgba(255, 255, 255, 0.3);
            }
        }

        @keyframes smooth-pulse-red {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 
                    0 0 20px rgba(220, 53, 69, 0.6),
                    0 0 40px rgba(220, 53, 69, 0.4),
                    inset 0 1px 3px rgba(255, 255, 255, 0.3);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.1);
                box-shadow: 
                    0 0 30px rgba(220, 53, 69, 0.8),
                    0 0 60px rgba(220, 53, 69, 0.6),
                    inset 0 1px 3px rgba(255, 255, 255, 0.3);
            }
        }

        @keyframes smooth-pulse-yellow {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 
                    0 0 20px rgba(255, 193, 7, 0.6),
                    0 0 40px rgba(255, 193, 7, 0.4),
                    inset 0 1px 3px rgba(255, 255, 255, 0.3);
            }
            50% { 
                opacity: 0.8; 
                transform: scale(1.15);
                box-shadow: 
                    0 0 30px rgba(255, 193, 7, 0.8),
                    0 0 60px rgba(255, 193, 7, 0.6),
                    inset 0 1px 3px rgba(255, 255, 255, 0.3);
            }
        }

        /* Hover effect สำหรับไฟ */
        .status-indicator:hover {
            transform: scale(1.2);
            transition: transform 0.2s ease;
        }

        .version-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 10px;
            border-radius: 15px;
        }

        /* Autocomplete UI Styles */
        .ui-autocomplete {
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Kanit', sans-serif;
            font-size: 16px;
            z-index: 9999 !important;
        }

        .ui-menu-item {
            padding: 8px 12px;
        }

        .ui-menu-item:hover {
            background-color: #e3f2fd;
        }

        .ui-state-active,
        .ui-widget-content .ui-state-active {
            background: #2196f3;
            color: white;
            border: 1px solid #1976d2;
        }

        /* ===== SweetAlert2 Modern Styles ===== */
        .sweet-popup-modern {
            border-radius: 20px !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3) !important;
        }

        .sweet-title-modern {
            font-size: 24px !important;
            font-weight: 600 !important;
            margin-bottom: 20px !important;
        }

        /* ===== SweetAlert2 สไตล์หน่วยงาน ===== */
        .government-popup {
            border-radius: 12px !important;
            font-family: 'Kanit', sans-serif !important;
        }

        .government-btn-confirm {
            border-radius: 6px !important;
            font-weight: 500 !important;
        }

        .government-btn-cancel {
            border-radius: 6px !important;
            font-weight: 500 !important;
        }

        /* Animation for location spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Fade animations for SweetAlert */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translate3d(0, -100%, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        @keyframes fadeOutUp {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                transform: translate3d(0, -100%, 0);
            }
        }

        .animate__animated {
            animation-duration: 0.5s;
            animation-fill-mode: both;
        }

        .animate__fadeInDown {
            animation-name: fadeInDown;
        }

        .animate__fadeOutUp {
            animation-name: fadeOutUp;
        }

        /* ===== Employee Suggestion Popup ===== */
        .employee-suggestion-popup .swal2-html-container {
            text-align: left !important;
        }
        
        .employee-suggestion-popup [onclick^="selectSuggestedEmployee"]:hover {
            background-color: rgba(44, 90, 160, 0.1) !important;
            border-radius: 4px !important;
        }
    </style>
</head>

<!-- ******* Time Tracker HTML Body *********** -->
<body>
    <div class="wrapper text-center" style="max-width:350px">
        <!-- ไฟสถานะมุมขวาบน -->
        <div id="status-indicator" class="status-indicator status-connecting" title="สถานะการเชื่อมต่อ"></div>
        
        <div class="site-logo text-center"></div>
        <h5>ระบบลงเวลาออนไลน์ อบต.ข่าใหญ่</h5>

        <span id="MyClockDisplay" class="clock mt-3" onload="showTime()"></span>

        <form id="myForm">
            <div class="row mt-4">
                <div class="form-group col">
                    <label for="employee">พิมพ์ชื่อหรือรหัส </label>
                    <input id="employee" class="text-center"> <br>
                </div>
            </div>

            <div class="row mt-4">
                <div class="form-group col">
                    <label for="lblinfo"><i class="fas fa-book-reader"></i> หมายเหตุ:ประชุม/กิจกรรม อื่นๆ</label>
                    <input type="search" class="form-control form-control-lg" id="userinfo" name="userinfo" list="list">
                    <datalist id="list">
                        <option value="ไปราชการ">ไปราชการ</option>
                        <option value="ลากิจ">ลากิจ</option>
                        <option value="ลาป่วย">ลาป่วย</option>
                        <option value="ลาคลอด">ลาคลอด</option>
                    </datalist>
                </div>
            </div>

            <div class="row mt-4 g-2">
                <div class="col-6">
                    <button id="clockin" type="button" class="btn btn-lg btn-primary w-100">Clock In</button>
                </div>
                <div class="col-6">
                    <button id="clockout" type="button" class="btn btn-lg btn-warning w-100">Clock Out</button>
                </div>
            </div>

            <div class="row mt-4">
                <div class="form-group col">
                    <div class="alert" role="alert" id="message"></div>
                </div>
            </div>
        </form>
    </div>

    <!-- Version info -->
    <div class="version-info">
        <span id="app-version">v2.1.0</span> | 
        <span id="server-status">Songphon</span>
    </div>

    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        // VConsole สำหรับ debug (เปิดเฉพาะ development)
        // var vConsole = new window.VConsole();
    </script>

    <!-- ******* Javascript *********** -->
    <script>
        // ===== Configuration =====
        var isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
        var apiUrl = isProduction ? 
            window.location.origin + '/api' : 
            'http://localhost:3000/api';
        
        var owner = 'องค์การบริหารส่วนตำบลข่าใหญ่';
        var connectionRetryCount = 0;
        var maxRetries = 3;

        // GPS Variables - ทำงานเบื้องหลัง
        var gps = null;
        var isGpsReady = false;
        var gpsWatchId = null;
        var hasRequestedPermission = false;

        console.log('🌐 API URL:', apiUrl);
        console.log('🏢 Environment:', isProduction ? 'Production' : 'Development');

        var profile;

        // ตรวจสอบการเชื่อมต่อกับ server
        async function checkServerConnection() {
            try {
                const response = await fetch(apiUrl + '/health');
                const data = await response.json();
                
                if (response.ok && data.status === 'healthy') {
                    updateConnectionStatus('online');
                    connectionRetryCount = 0;
                    return true;
                } else {
                    throw new Error('Server unhealthy');
                }
            } catch (error) {
                console.error('❌ Connection check failed:', error);
                updateConnectionStatus('offline');
                
                if (connectionRetryCount < maxRetries) {
                    connectionRetryCount++;
                    setTimeout(checkServerConnection, 5000);
                    updateConnectionStatus('connecting');
                }
                
                return false;
            }
        }

        // ฟังก์ชันอัพเดทสถานะไฟ - แค่เปลี่ยนสี ไม่มีข้อความ
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('status-indicator');
            
            // ลบ class เก่าทั้งหมด
            indicator.classList.remove('status-online', 'status-offline', 'status-connecting');
            
            // เพิ่ม class ใหม่
            indicator.classList.add(`status-${status}`);
            
            // อัพเดท tooltip
            const statusText = {
                online: 'เชื่อมต่อแล้ว',
                offline: 'ไม่สามารถเชื่อมต่อได้',
                connecting: 'กำลังเชื่อมต่อ...'
            };
            
            indicator.title = statusText[status] || 'ไม่ทราบสถานะ';
            
            console.log(`🔘 Status updated: ${status}`);
        }        // ======== GPS Functions - ถามครั้งเดียวด้วยป็อปอัพสวย ========
        async function initializeGPS() {
            console.log('📍 Initializing GPS with modern popup...');

            if (!navigator.geolocation) {
                console.warn('❌ Geolocation not supported');
                getFallbackLocation();
                return;
            }

            // ไม่ขอตำแหน่งแบบเงียบๆ แล้ว ให้รอจนกว่าผู้ใช้จะกดลงเวลา
            console.log('📍 GPS initialization ready, waiting for user action...');
        }

        function onGpsSuccess(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            gps = [lat, lon];
            isGpsReady = true;
            
            console.log(`✅ GPS Ready: ${lat}, ${lon} (accuracy: ${Math.round(accuracy)}m)`);
        }

        function onGpsUpdate(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            gps = [lat, lon];
            console.log(`📍 GPS Updated: ${lat}, ${lon}`);
        }        function onGpsError(error) {
            console.warn('⚠️ GPS Error:', error.code, error.message);
            
            // ไม่ทำอะไร เพียงแค่ log error เพื่อให้ผู้ใช้ขออนุญาตเอง
            console.log('📍 GPS error occurred, user will need to grant permission manually');
            isGpsReady = false;
            gps = null;
        }function getFallbackLocation() {
            console.log('🔄 Using fallback location methods...');
            
            // วิธีที่ 1: URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const urlLat = urlParams.get('lat');
            const urlLon = urlParams.get('lon');
            
            if (urlLat && urlLon) {
                gps = [parseFloat(urlLat), parseFloat(urlLon)];
                isGpsReady = true;
                console.log('📍 Using URL location:', gps);
                return;
            }
            
            // วิธีที่ 2: IP Geolocation
            fetch('https://ipapi.co/json/')
                .then(response => response.json())
                .then(data => {
                    if (data.latitude && data.longitude) {
                        gps = [data.latitude, data.longitude];
                        isGpsReady = true;
                        console.log('📍 Using IP location:', gps);
                    } else {
                        throw new Error('No location from IP');
                    }
                })
                .catch(error => {
                    console.warn('⚠️ IP location failed:', error);
                    
                    // ไม่ใช้ตำแหน่งพื้นฐาน - ให้ผู้ใช้ต้องเปิด GPS เท่านั้น
                    console.log('❌ No fallback location available');
                    isGpsReady = false;
                    gps = null;
                });
        }        // ======== SweetAlert2 GPS Permission ========
        async function requestGPSPermission() {
            hasRequestedPermission = true;
            
            const result = await Swal.fire({
                title: '🌟 ขออนุญาตเข้าถึงตำแหน่ง',
                html: `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 80px; margin-bottom: 20px;">📍</div>
                        <div style="font-size: 18px; color: #4a90e2; margin-bottom: 15px;">
                            เพื่อการลงเวลาที่แม่นยำ
                        </div>
                        <div style="font-size: 14px; color: #666; line-height: 1.6;">
                            ระบบต้องการเข้าถึงตำแหน่งของคุณ<br>
                            เพื่อบันทึกข้อมูลการเข้า-ออกงานอย่างถูกต้อง
                        </div>
                    </div>
                `,
                icon: null,
                showCancelButton: true,
                confirmButtonText: '✨ อนุญาต',
                cancelButtonText: '❌ ไม่อนุญาต',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#dc3545',
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                color: 'white',
                customClass: {
                    popup: 'sweet-popup-modern',
                    title: 'sweet-title-modern'
                },
                showClass: {
                    popup: 'animate__animated animate__fadeInDown'
                },
                hideClass: {
                    popup: 'animate__animated animate__fadeOutUp'
                },
                allowOutsideClick: false
            });

            if (result.isConfirmed) {
                // แสดง loading สวยๆ
                Swal.fire({
                    title: '🔍 กำลังค้นหาตำแหน่ง',
                    html: `
                        <div style="text-align: center; padding: 20px;">
                            <div class="location-spinner" style="
                                width: 60px; 
                                height: 60px; 
                                border: 4px solid #f3f3f3; 
                                border-top: 4px solid #4a90e2; 
                                border-radius: 50%; 
                                animation: spin 1s linear infinite;
                                margin: 0 auto 20px;
                            "></div>
                            <div style="color: #4a90e2; font-size: 16px;">
                                โปรดรอสักครู่...
                            </div>
                        </div>
                        <style>
                            @keyframes spin {
                                0% { transform: rotate(0deg); }
                                100% { transform: rotate(360deg); }
                            }
                        </style>
                    `,
                    timer: 8000,
                    timerProgressBar: true,
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    color: 'white'
                });                // ขอตำแหน่งด้วยการตั้งค่าที่แม่นยำ และเริ่ม watch position
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        
                        gps = [lat, lon];
                        isGpsReady = true;
                        hasRequestedPermission = true;
                        
                        console.log(`✅ GPS Permission granted: ${lat}, ${lon}`);
                        
                        // เริ่ม watch position หลังจากได้อนุญาตแล้ว
                        gpsWatchId = navigator.geolocation.watchPosition(
                            onGpsUpdate,
                            onGpsError,
                            {
                                enableHighAccuracy: true,
                                timeout: 8000,
                                maximumAge: 30000
                            }
                        );
                        
                        Swal.fire({
                            title: '🎉 สำเร็จ!',
                            html: `
                                <div style="text-align: center; padding: 20px;">
                                    <div style="font-size: 60px; margin-bottom: 15px;">✅</div>
                                    <div style="font-size: 16px; color: #28a745; margin-bottom: 10px;">
                                        พบตำแหน่งแล้ว
                                    </div>
                                    <div style="font-size: 14px; color: #666;">
                                        ความแม่นยำ: ${Math.round(accuracy)} เมตร
                                    </div>
                                </div>
                            `,
                            icon: null,
                            timer: 2500,
                            showConfirmButton: false,
                            background: 'linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%)',
                            color: 'white'
                        });
                    },
                    (error) => {
                        console.error('❌ GPS Permission error:', error);
                        
                        Swal.fire({
                            title: '⚠️ ไม่สามารถระบุตำแหน่งได้',
                            html: `
                                <div style="text-align: center; padding: 20px;">
                                    <div style="font-size: 60px; margin-bottom: 15px;">❌</div>
                                    <div style="font-size: 16px; color: #e74c3c; margin-bottom: 10px;">
                                        กรุณาเปิด GPS และอนุญาตการเข้าถึงตำแหน่ง
                                    </div>
                                    <div style="font-size: 14px; color: #666; line-height: 1.5;">
                                        หรือตรวจสอบการตั้งค่าเบราว์เซอร์<br>
                                        เพื่อให้สามารถลงเวลาได้อย่างถูกต้อง
                                    </div>
                                </div>
                            `,
                            icon: null,
                            confirmButtonText: '🔄 ลองใหม่',
                            confirmButtonColor: '#e74c3c',
                            background: 'linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%)',
                            color: 'white'
                        });
                        
                        // ไม่ใช้ fallback location
                        isGpsReady = false;
                        gps = null;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            } else {
                // ผู้ใช้ไม่อนุญาต
                Swal.fire({
                    title: '🚫 ไม่สามารถลงเวลาได้',
                    html: `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 60px; margin-bottom: 15px;">🚫</div>
                            <div style="font-size: 16px; color: #e74c3c; margin-bottom: 10px;">
                                ต้องอนุญาตการเข้าถึงตำแหน่งเพื่อลงเวลา
                            </div>
                            <div style="font-size: 14px; color: #666;">
                                กรุณาเปิด GPS และลองใหม่อีกครั้ง
                            </div>
                        </div>
                    `,
                    icon: null,
                    confirmButtonText: '👍 เข้าใจแล้ว',
                    confirmButtonColor: '#6c757d',
                    background: 'linear-gradient(135deg, #636363 0%, #a2a2a2 100%)',
                    color: 'white'
                });
                
                // ไม่ใช้ fallback location
                isGpsReady = false;
                gps = null;
            }        }

        // ======== GPS Permission - สไตล์หน่วยงาน (ถามครั้งเดียว) ========
        async function requestGPSPermission() {
            if (hasRequestedPermission && isGpsReady && gps) {
                return; // ถ้าได้อนุญาตแล้วไม่ต้องถามซ้ำ
            }
            
            hasRequestedPermission = true;
            
            const result = await Swal.fire({
                title: 'ขออนุญาตเข้าถึงตำแหน่ง',
                html: `
                    <div style="text-align: center; padding: 15px;">
                        <div style="font-size: 64px; margin-bottom: 15px; color: #00a8cc;">📍</div>
                        <div style="font-size: 16px; color: #2c5aa0; margin-bottom: 12px; font-weight: 500;">
                            เพื่อระบุตำแหน่งการลงเวลาให้แม่นยำ
                        </div>
                        <div style="font-size: 14px; color: #546e7a; line-height: 1.5;">
                            ระบบต้องการตรวจสอบตำแหน่งของท่าน<br>
                            เพื่อบันทึกข้อมูลการเข้า-ออกงานอย่างถูกต้อง
                        </div>
                    </div>
                `,
                icon: null,
                showCancelButton: true,
                confirmButtonText: 'อนุญาต',
                cancelButtonText: 'ไม่อนุญาต',
                confirmButtonColor: '#2c5aa0',
                cancelButtonColor: '#78909c',
                background: 'rgba(240, 248, 255, 0.95)',
                color: '#37474f',
                backdrop: 'rgba(0,0,0,0.3)',
                allowOutsideClick: false,
                width: '380px',
                padding: '25px'
            });

            if (result.isConfirmed) {
                // แสดง loading และขอตำแหน่งในขั้นตอนเดียว
                const loadingPromise = Swal.fire({
                    title: 'กำลังค้นหาตำแหน่ง',
                    html: `
                        <div style="text-align: center; padding: 20px;">
                            <div style="
                                width: 40px; 
                                height: 40px; 
                                border: 3px solid #e3f2fd; 
                                border-top: 3px solid #2c5aa0; 
                                border-radius: 50%; 
                                animation: spin 1s linear infinite;
                                margin: 0 auto 15px;
                            "></div>
                            <div style="color: #546e7a; font-size: 14px;">
                                โปรดรอสักครู่...
                            </div>
                        </div>
                    `,
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    background: 'rgba(240, 248, 255, 0.95)',
                    color: '#37474f',
                    width: '320px',
                    padding: '20px'
                });

                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 0
                        });
                    });

                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    gps = [lat, lon];
                    isGpsReady = true;
                    
                    console.log(`✅ GPS Permission granted: ${lat}, ${lon}`);
                    
                    // เริ่ม watch position
                    gpsWatchId = navigator.geolocation.watchPosition(
                        onGpsUpdate,
                        onGpsError,
                        {
                            enableHighAccuracy: true,
                            timeout: 8000,
                            maximumAge: 30000
                        }
                    );
                    
                    // ปิด loading และแสดงผลสำเร็จ
                    Swal.close();
                    
                    // แสดงข้อความสำเร็จแบบ toast เรียบๆ
                    const successToast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2500,
                        timerProgressBar: true,
                        background: 'rgba(76, 175, 80, 0.9)',
                        color: 'white',
                        width: '320px'
                    });
                    
                    successToast.fire({
                        title: `📍 ระบุตำแหน่งสำเร็จ`,
                        text: `ความแม่นยำ ${Math.round(accuracy)} เมตร`
                    });

                } catch (error) {
                    console.error('❌ GPS Permission error:', error);
                    
                    Swal.fire({
                        title: 'ไม่สามารถระบุตำแหน่งได้',
                        html: `
                            <div style="text-align: center; padding: 15px;">
                                <div style="font-size: 48px; margin-bottom: 15px; color: #f57c00;">⚠️</div>
                                <div style="font-size: 16px; color: #d84315; margin-bottom: 10px;">
                                    กรุณาตรวจสอบการตั้งค่า GPS
                                </div>
                                <div style="font-size: 14px; color: #546e7a; line-height: 1.5;">
                                    • เปิดการใช้งาน GPS ในอุปกรณ์<br>
                                    • อนุญาตการเข้าถึงตำแหน่งในเบราว์เซอร์<br>
                                    • ลองรีเฟรชหน้าเว็บและทำใหม่
                                </div>
                            </div>
                        `,
                        icon: null,
                        confirmButtonText: 'เข้าใจแล้ว',
                        confirmButtonColor: '#2c5aa0',
                        background: 'rgba(255, 248, 225, 0.95)',
                        color: '#37474f',
                        width: '400px'
                    });
                    
                    isGpsReady = false;
                    gps = null;
                }
            } else {
                // ผู้ใช้ไม่อนุญาต
                Swal.fire({
                    title: 'ไม่สามารถใช้งานระบบได้',
                    html: `
                        <div style="text-align: center; padding: 15px;">
                            <div style="font-size: 48px; margin-bottom: 15px; color: #78909c;">🚫</div>
                            <div style="font-size: 16px; color: #546e7a; margin-bottom: 10px;">
                                จำเป็นต้องอนุญาตการเข้าถึงตำแหน่งเพื่อใช้งาน
                            </div>
                            <div style="font-size: 14px; color: #78909c;">
                                กรุณารีเฟรชหน้าเว็บและอนุญาตการเข้าถึงตำแหน่ง
                            </div>
                        </div>
                    `,
                    icon: null,
                    confirmButtonText: 'เข้าใจแล้ว',
                    confirmButtonColor: '#78909c',
                    background: 'rgba(250, 250, 250, 0.95)',
                    color: '#37474f',
                    width: '380px'
                });
                
                isGpsReady = false;
                gps = null;
            }
        }        async function ClockIn() {
            event.preventDefault();
            
            var employee = document.getElementById("employee").value;
            var userinfo = document.getElementById("userinfo").value;

            if (employee != '') {
                // ตรวจสอบรายชื่อพนักงานก่อน
                if (!isValidEmployee(employee)) {
                    showInvalidEmployeeAlert(employee);
                    return;
                }
                
                // ตรวจสอบ GPS - ใช้ป็อปอัพสไตล์หน่วยงาน (ถามครั้งเดียว)
                if (!isGpsReady || !gps || !hasRequestedPermission) {
                    console.log('📍 GPS not ready, requesting permission with government style popup...');
                    await requestGPSPermission();
                    
                    // ถ้ายังไม่พร้อมให้ออกจากฟังก์ชัน
                    if (!isGpsReady || !gps) {
                        return; // ออกจากฟังก์ชันเลย เพราะ requestGPSPermission จะแสดงข้อความเตือนแล้ว
                    }
                }

                $('#message').html("<span class='spinner-border spinner-border-sm text-primary'></span> โปรดรอสักครู่ ...!");
                
                try {
                    if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                        profile = liff.getDecodedIDToken();
                    }

                    console.log('⏰ Sending Clock In request:', {
                        employee,
                        userinfo,
                        lat: gps[0],
                        lon: gps[1]
                    });

                    const response = await fetch(apiUrl + '/clockin', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            employee,
                            userinfo,
                            lat: gps[0],
                            lon: gps[1],
                            line_name: profile ? profile.name : 'ผู้ใช้งาน',
                            line_picture: profile ? profile.picture : ''
                        })
                    });

                    const result = await response.json();
                    console.log('⏰ Clock In result:', result);
                    
                    if (result.success) {
                        setTimeout(() => {
                            var message = result.employee + '<br> บันทึกเวลามา ' + result.time;
                            $('#message').html(message);
                            document.getElementById("message").className = "alert alert-primary";
                            clearForm();
                        }, 500);
                    } else {
                        var message = result.employee + ' ' + result.message;
                        $('#message').html(message);
                        document.getElementById("message").className = "alert alert-warning";
                        clearForm();
                    }

                } catch (error) {
                    console.error('❌ Clock in error:', error);
                    $('#message').html('⚠️ เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง');
                    document.getElementById("message").className = "alert alert-danger";
                    clearForm();
                }            } else {
                // แสดงข้อความเตือนเมื่อไม่ได้กรอกชื่อ
                Swal.fire({
                    title: 'กรุณากรอกชื่อพนักงาน',
                    html: `
                        <div style="text-align: center; padding: 15px;">
                            <div style="font-size: 48px; margin-bottom: 15px; color: #f57c00;">📝</div>
                            <div style="font-size: 16px; color: #d84315; margin-bottom: 10px;">
                                โปรดกรอกชื่อพนักงานเพื่อลงเวลาเข้างาน
                            </div>
                            <div style="font-size: 14px; color: #546e7a;">
                                เลือกชื่อจากรายการที่แสดงขึ้นเมื่อพิมพ์
                            </div>
                        </div>
                    `,
                    icon: null,
                    confirmButtonText: 'เข้าใจแล้ว',
                    confirmButtonColor: '#2c5aa0',
                    background: 'rgba(255, 248, 225, 0.95)',
                    color: '#37474f',
                    width: '380px'
                });
                clearForm();
            }
        }        async function ClockOut() {
            event.preventDefault();
            
            var employee = document.getElementById("employee").value;
              if (employee != '') {
                // ตรวจสอบรายชื่อพนักงานก่อน
                if (!isValidEmployee(employee)) {
                    showInvalidEmployeeAlert(employee);
                    return;
                }
                
                // ตรวจสอบ GPS - ใช้ป็อปอัพสไตล์หน่วยงาน (ถามครั้งเดียว) เหมือนลงเวลาเข้า
                if (!isGpsReady || !gps || !hasRequestedPermission) {
                    console.log('📍 GPS not ready, requesting permission with government style popup...');
                    await requestGPSPermission();
                    
                    // ถ้ายังไม่พร้อมให้ออกจากฟังก์ชัน
                    if (!isGpsReady || !gps) {
                        return; // ออกจากฟังก์ชันเลย เพราะ requestGPSPermission จะแสดงข้อความเตือนแล้ว
                    }
                }

                $('#message').html("<span class='spinner-border spinner-border-sm text-warning'></span> โปรดรอสักครู่ ...!");
                
                try {
                    if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                        profile = liff.getDecodedIDToken();
                    }

                    console.log('⏰ Sending Clock Out request:', {
                        employee,
                        lat: gps[0],
                        lon: gps[1]
                    });

                    const response = await fetch(apiUrl + '/clockout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            employee,
                            lat: gps[0],
                            lon: gps[1],
                            line_name: profile ? profile.name : 'ผู้ใช้งาน',
                            line_picture: profile ? profile.picture : ''
                        })
                    });

                    const result = await response.json();
                    console.log('⏰ Clock Out result:', result);
                    
                    if (result.success) {
                        setTimeout(() => {
                            var message = result.employee + '<br> บันทึกเวลากลับ ' + result.time;
                            if (result.hours) {
                                message += '<br>ทำงานรวม ' + result.hours + ' ชั่วโมง';
                            }
                            $('#message').html(message);
                            document.getElementById("message").className = "alert alert-primary";
                            clearForm();
                        }, 500);
                    } else {
                        var message = result.employee + ' ' + result.message;
                        $('#message').html(message);
                        document.getElementById("message").className = "alert alert-warning";
                        clearForm();
                    }

                } catch (error) {
                    console.error('❌ Clock out error:', error);
                    $('#message').html('⚠️ เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง');
                    document.getElementById("message").className = "alert alert-danger";
                    clearForm();
                }            } else {
                // แสดงข้อความเตือนเมื่อไม่ได้กรอกชื่อ
                Swal.fire({
                    title: 'กรุณากรอกชื่อพนักงาน',
                    html: `
                        <div style="text-align: center; padding: 15px;">
                            <div style="font-size: 48px; margin-bottom: 15px; color: #f57c00;">📝</div>
                            <div style="font-size: 16px; color: #d84315; margin-bottom: 10px;">
                                โปรดกรอกชื่อพนักงานเพื่อลงเวลาออกงาน
                            </div>
                            <div style="font-size: 14px; color: #546e7a;">
                                เลือกชื่อจากรายการที่แสดงขึ้นเมื่อพิมพ์
                            </div>
                        </div>
                    `,
                    icon: null,
                    confirmButtonText: 'เข้าใจแล้ว',
                    confirmButtonColor: '#2c5aa0',
                    background: 'rgba(255, 248, 225, 0.95)',
                    color: '#37474f',
                    width: '380px'
                });
                clearForm();
            }
        }

        $(document).ready(function () {
            let profile = null;

            // เริ่มระบบ GPS เบื้องหลังทันที
            initializeGPS();

            // ตรวจสอบการเชื่อมต่อ
            checkServerConnection();

            $('#clockin').click(() => ClockIn());
            $('#clockout').click(() => ClockOut());

            // เช็คว่ามี LIFF ไหม (สำหรับ LINE)
            if (typeof liff !== 'undefined') {
                liff.init({
                    liffId: '2006435262-Ebxr8BpG',
                    withLoginOnExternalBrowser: true
                });

                liff.ready.then(() => {
                    profile = liff.getDecodedIDToken();

                    if (profile) {
                        console.log("🚀 LINE Profile loaded:", profile.name);
                    } else {
                        console.log("⚠️ No LINE profile available");
                    }

                    initApp();
                });
            } else {
                console.log("⚠️ LIFF not available, using fallback");
                profile = {
                    name: 'ผู้ใช้งาน',
                    picture: ''
                };
                initApp();
            }

            function initApp() {
                document.getElementById('message').innerText = owner;
                document.getElementById('message').className = 'alert msgBg';
                
                // รอให้ jQuery UI โหลดเสร็จก่อนโหลดข้อมูลพนักงาน
                console.log('🔧 Initializing app...');
                console.log('📚 jQuery version:', $.fn.jquery);
                console.log('📚 jQuery UI loaded:', typeof $.fn.autocomplete !== 'undefined');
                
                // รอสักครู่แล้วค่อยโหลดข้อมูลพนักงาน
                setTimeout(() => {
                    loadEmployees();
                }, 500);
            }
        });

        async function loadEmployees() {
            try {
                console.log('👥 Loading employees...');
                
                const response = await fetch(apiUrl + '/employees', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('📊 Employee data received:', data);
                
                if (data.success && data.data && Array.isArray(data.data)) {
                    var dataPerson = data.data;
                    console.log('👥 Employees loaded successfully:', dataPerson.length, 'employees');
                    console.log('📋 Sample employees:', dataPerson.slice(0, 3));
                    
                    // ตรวจสอบว่า jQuery UI พร้อมใช้งานแล้ว
                    if (typeof $.fn.autocomplete === 'undefined') {
                        console.error('❌ jQuery UI Autocomplete not loaded');
                        return;
                    }                    // ตั้งค่า Autocomplete ที่ปรับปรุงแล้ว - Fast & Accurate
                    $("#employee").autocomplete({
                        source: function(request, response) {
                            // ค้นหาแบบเฉพาะเจาะจง - ทั้งชื่อที่ขึ้นต้นและที่มีคำที่ค้นหา
                            const term = request.term.toLowerCase().trim();
                            
                            if (term === '') {
                                response(dataPerson.slice(0, 10)); // แสดง 10 รายการแรก
                                return;
                            }

                            const exactMatches = [];
                            const startsWith = [];
                            const contains = [];

                            // ใช้ for loop แทน forEach เพื่อความเร็ว
                            for (let i = 0; i < dataPerson.length; i++) {
                                const person = dataPerson[i];
                                const personLower = person.toLowerCase();
                                
                                // 1. ตรงกันทุกตัวอักษร (สำคัญที่สุด)
                                if (personLower === term) {
                                    exactMatches.push(person);
                                }
                                // 2. ขึ้นต้นด้วยคำที่ค้นหา
                                else if (personLower.startsWith(term)) {
                                    startsWith.push(person);
                                }
                                // 3. มีคำที่ค้นหาอยู่ในชื่อ
                                else if (personLower.includes(term)) {
                                    contains.push(person);
                                }
                                
                                // หยุดค้นหาเมื่อได้ผลลัพธ์เพียงพอแล้ว
                                if (exactMatches.length + startsWith.length + contains.length >= 10) {
                                    break;
                                }
                            }

                            // รวมผลลัพธ์ตามลำดับความสำคัญ และจำกัดที่ 8 รายการ
                            const sortedMatches = [...exactMatches, ...startsWith, ...contains].slice(0, 8);
                            response(sortedMatches);
                        },
                        minLength: 1, // แสดงผลเมื่อพิมพ์ 1 ตัวอักษร
                        delay: 100, // หน่วงเวลาเพียง 100ms เพื่อความเร็ว
                        autoFocus: true, // เลือกรายการแรกอัตโนมัติ
                        select: function(event, ui) {
                            // เมื่อเลือกชื่อแล้ว
                            console.log('👤 Selected employee:', ui.item.value);
                            
                            // แสดงข้อความยืนยันแบบ toast
                            setTimeout(() => {
                                const confirmToast = Swal.mixin({
                                    toast: true,
                                    position: 'top-end',
                                    showConfirmButton: false,
                                    timer: 1500,
                                    timerProgressBar: true,
                                    background: 'rgba(76, 175, 80, 0.9)',
                                    color: 'white',
                                    width: '280px',
                                    customClass: {
                                        popup: 'fast-toast'
                                    }
                                });
                                
                                confirmToast.fire({
                                    title: `✅ เลือก: ${ui.item.value}`
                                });
                            }, 50);
                        },
                        focus: function(event, ui) {
                            // แสดงตัวอย่างเมื่อ focus (ไม่ต้อง log เพื่อประสิทธิภาพ)
                            return false; // ป้องกันการเปลี่ยนค่าใน input ขณะ focus
                        },
                        search: function(event, ui) {
                            console.log('🔍 Searching for:', this.value);
                        },
                        response: function(event, ui) {
                            console.log('📋 Search results:', ui.content.length, 'items found');
                            
                            // แสดงข้อความถ้าไม่มีผลลัพธ์
                            if (ui.content.length === 0 && $(this).val().trim() !== '') {
                                ui.content.push({
                                    label: '🔍 ไม่พบรายชื่อที่ตรงกัน - กรุณาลองพิมพ์ใหม่',
                                    value: '',
                                    disabled: true
                                });
                            }
                        }
                    });
                    
                    console.log('✅ Fast Autocomplete initialized successfully');
                    
                    // เก็บรายชื่อพนักงานที่ถูกต้องสำหรับการตรวจสอบ
                    validEmployees = dataPerson;
                    
                    // สร้าง search index สำหรับค้นหาเร็ว
                    buildEmployeeSearchIndex(dataPerson);
                    
                    console.log('✅ Valid employees list updated:', validEmployees.length, 'names');
                    console.log('✅ Search index built with', employeeSearchIndex.size, 'entries');
                    
                    // ทดสอบ Autocomplete
                    const testInput = $("#employee");
                    if (testInput.length > 0) {
                        console.log('✅ Employee input field found');
                    } else {
                        console.error('❌ Employee input field not found');
                    }
                    
                    // เก็บรายชื่อพนักงานที่ถูกต้องสำหรับการตรวจสอบ
                    validEmployees = dataPerson.map(emp => emp.toLowerCase());
                    
                } else {
                    throw new Error(data.error || 'Invalid employee data format');
                }

            } catch (error) {
                console.error('❌ Failed to load employees:', error);
                $('#message').html('⚠️ ไม่สามารถโหลดรายชื่อพนักงานได้: ' + error.message);
                document.getElementById("message").className = "alert alert-warning";
                
                // ลองใช้ข้อมูลตัวอย่างถ้าโหลดไม่ได้
                console.log('🔄 Using sample employee data for testing...');
                const sampleEmployees = [
                    'นายสมชาย ใจดี',
                    'นางสาวสมใส รักงาน', 
                    'นายวิชัย ขยันดี',
                    'นางมณี สุภาพ',
                    'นายกิตติ มั่นใจ'
                ];
                  $("#employee").autocomplete({
                    source: sampleEmployees,
                    minLength: 1,
                    delay: 100,
                    autoFocus: true
                });
                
                console.log('✅ Sample autocomplete initialized');
            }
        }
        
        // ======== Employee Validation Functions - Fast & Accurate ========        let validEmployees = []; // เก็บรายชื่อพนักงานที่ถูกต้อง
        let employeeSearchIndex = new Map(); // สร้าง index สำหรับค้นหาเร็ว
        let employeeCache = new Map(); // เก็บผลลัพธ์การค้นหาไว้ cache
        
        // ฟังก์ชันสร้าง search index แบบเร็ว (ปรับปรุงแล้ว)
        function buildEmployeeSearchIndex(employees) {
            console.log('🔧 Building fast search index...');
            const startTime = Date.now();
            
            employeeSearchIndex.clear();
            employeeCache.clear();
            
            employees.forEach((employee, index) => {
                const normalizedName = employee.toLowerCase().trim();
                
                // เก็บชื่อเต็ม
                employeeSearchIndex.set(normalizedName, {
                    originalName: employee,
                    index: index,
                    score: 100 // คะแนนสูงสุดสำหรับชื่อเต็ม
                });
                
                // เก็บคำแต่ละคำในชื่อ
                const words = normalizedName.split(/\s+/);
                words.forEach((word, wordIndex) => {
                    if (word.length > 1) {
                        const key = `${word}_${index}`;
                        if (!employeeSearchIndex.has(key)) {
                            employeeSearchIndex.set(key, {
                                originalName: employee,
                                index: index,
                                score: 80 - (wordIndex * 5), // คะแนนลดลงตามลำดับคำ
                                isPartial: true,
                                word: word
                            });
                        }
                    }
                });
                
                // เก็บคำย่อยสำหรับ fuzzy search
                for (let i = 2; i <= Math.min(normalizedName.length, 6); i++) {
                    for (let j = 0; j <= normalizedName.length - i; j++) {
                        const substr = normalizedName.substr(j, i);
                        const key = `sub_${substr}_${index}`;
                        if (!employeeSearchIndex.has(key)) {
                            employeeSearchIndex.set(key, {
                                originalName: employee,
                                index: index,
                                score: 50 - Math.abs(j), // คะแนนขึ้นอยู่กับตำแหน่ง
                                isSubstring: true,
                                substring: substr
                            });
                        }
                    }
                }
            });
            
            const endTime = Date.now();
            console.log(`✅ Search index built: ${employeeSearchIndex.size} entries in ${endTime - startTime}ms`);
        }
          // ฟังก์ชันตรวจสอบว่าชื่อพนักงานอยู่ในรายการหรือไม่ (ปรับปรุงแล้ว - เร็วขึ้น)
        function isValidEmployee(employeeName) {
            if (!employeeName || employeeName.trim() === '') {
                return false;
            }
            
            const normalizedInput = employeeName.toLowerCase().trim();
            
            // ตรวจสอบจาก cache ก่อน
            if (employeeCache.has(normalizedInput)) {
                return employeeCache.get(normalizedInput);
            }
            
            // ตรวจสอบแบบตรงกันทุกตัวอักษรก่อน (แม่นยำที่สุด)
            let isValid = false;
            if (employeeSearchIndex.has(normalizedInput)) {
                const result = employeeSearchIndex.get(normalizedInput);
                isValid = result.score === 100; // ต้องเป็นชื่อเต็ม
            }
            
            // ตรวจสอบแบบ exact match กับรายการเดิม (สำรอง)
            if (!isValid) {
                isValid = validEmployees.some(emp => emp.toLowerCase().trim() === normalizedInput);
            }
            
            // เก็บผลลัพธ์ใน cache
            employeeCache.set(normalizedInput, isValid);
            
            return isValid;
        }
        
        // ฟังก์ชันค้นหาชื่อที่คล้ายกัน (ปรับปรุงแล้ว - เร็วและแม่นยำขึ้น)
        function findSimilarEmployees(employeeName, limit = 3) {
            if (!employeeName) return [];
            
            const normalizedInput = employeeName.toLowerCase().trim();
            const cacheKey = `similar_${normalizedInput}_${limit}`;
            
            // ตรวจสอบ cache ก่อน
            if (employeeCache.has(cacheKey)) {
                return employeeCache.get(cacheKey);
            }
            
            const suggestions = new Map(); // ใช้ Map เพื่อป้องกันซ้ำ
            const startTime = Date.now();
            
            // 1. ค้นหาจาก search index
            for (const [key, data] of employeeSearchIndex) {
                if (suggestions.size >= limit * 2) break; // จำกัดเพื่อประสิทธิภาพ
                
                let score = 0;
                const originalName = data.originalName;
                const normalizedName = originalName.toLowerCase().trim();
                
                // คำนวณคะแนนความคล้าย
                if (normalizedName.includes(normalizedInput)) {
                    score = data.score + 20; // โบนัสถ้าตรงบางส่วน
                } else if (normalizedInput.includes(normalizedName)) {
                    score = data.score + 15;
                } else {
                    // ใช้ Levenshtein distance
                    const similarity = calculateSimilarity(normalizedInput, normalizedName);
                    if (similarity > 0.5) {
                        score = data.score + (similarity * 30);
                    }
                }
                
                if (score > 50) {
                    suggestions.set(originalName, {
                        name: originalName,
                        score: score
                    });
                }
            }
            
            // 2. เรียงลำดับตามคะแนน
            const sortedSuggestions = Array.from(suggestions.values())
                .sort((a, b) => b.score - a.score)
                .slice(0, limit)
                .map(item => item.name);
            
            const endTime = Date.now();
            console.log(`🔍 Found ${sortedSuggestions.length} suggestions in ${endTime - startTime}ms`);
            
            // เก็บใน cache
            employeeCache.set(cacheKey, sortedSuggestions);
            
            return sortedSuggestions;
        }
        
        // ฟังก์ชันคำนวณความคล้ายคลึงแบบง่าย
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }
        
        // ฟังก์ชันคำนวณ Levenshtein distance
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
          // ฟังก์ชันแสดงข้อความเตือนเมื่อชื่อไม่ถูกต้อง (ปรับปรุงแล้ว)
        function showInvalidEmployeeAlert(employeeName) {
            const similarNames = findSimilarEmployees(employeeName);
            
            let suggestionsHtml = '';
            if (similarNames.length > 0) {
                suggestionsHtml = `
                    <div style="margin-top: 15px; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 6px;">
                        <div style="font-size: 14px; color: #2c5aa0; margin-bottom: 8px; font-weight: 500;">
                            🔍 ชื่อที่คล้ายกัน:
                        </div>
                        ${similarNames.map(name => 
                            `<div style="font-size: 13px; color: #1976d2; cursor: pointer; padding: 2px 0;" 
                                 onclick="selectSuggestedEmployee('${name.replace(/'/g, "\\'")}')">
                                • ${name}
                            </div>`
                        ).join('')}
                    </div>
                `;
            }
            
            Swal.fire({
                title: 'ไม่พบรายชื่อในระบบ',
                html: `
                    <div style="text-align: center; padding: 15px;">
                        <div style="font-size: 48px; margin-bottom: 15px; color: #f57c00;">👤</div>
                        <div style="font-size: 16px; color: #d84315; margin-bottom: 10px;">
                            "<strong>${employeeName}</strong>" ไม่อยู่ในรายการพนักงาน
                        </div>
                        <div style="font-size: 14px; color: #546e7a; line-height: 1.5; margin-bottom: 10px;">
                            กรุณาเลือกชื่อจากรายการที่แสดงขึ้นเมื่อพิมพ์<br>
                            หรือติดต่อผู้ดูแลระบบเพื่อเพิ่มรายชื่อ
                        </div>
                        ${suggestionsHtml}
                    </div>
                `,
                icon: null,
                confirmButtonText: 'เข้าใจแล้ว',
                confirmButtonColor: '#2c5aa0',
                background: 'rgba(255, 248, 225, 0.95)',
                color: '#37474f',
                width: '420px',
                customClass: {
                    popup: 'employee-suggestion-popup'
                }
            });
        }
        
        // ฟังก์ชันสำหรับเลือกชื่อที่แนะนำ
        function selectSuggestedEmployee(employeeName) {
            document.getElementById('employee').value = employeeName;
            Swal.close();
            
            // แสดงข้อความยืนยัน
            const confirmToast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true,
                background: 'rgba(76, 175, 80, 0.9)',
                color: 'white',
                width: '280px'
            });
            
            confirmToast.fire({
                title: `✅ เลือก: ${employeeName}`
            });
        }

        function clearForm() {
            setTimeout(function () {
                document.getElementById('message').innerText = owner;
                document.getElementById("message").className = "alert msgBg";
                document.getElementById("myForm").reset();
            }, 5000);
        }

        /** จาวาสคริปต์ นาฬิกาดิจิตอล **/
        function showTime() {
            var date = new Date();
            var h = date.getHours();
            var m = date.getMinutes();
            var s = date.getSeconds();
            var dot = document.textContent = '.';

            if (s % 2 == 1) {
                dot = document.textContent = '.';
            } else {
                dot = document.textContent = '\xa0';
            }

            h = h < 10 ? "0" + h : h;
            m = m < 10 ? "0" + m : m;
            s = s < 10 ? "0" + s : s;

            var time = h + ":" + m + ":" + s + '' + dot;
            document.getElementById("MyClockDisplay").innerText = time;
            document.getElementById("MyClockDisplay").textContent = time;

            setTimeout(showTime, 1000);
        }

        // เริ่มต้นการทำงาน
        showTime();
        
        // ตรวจสอบการเชื่อมต่อทุก 30 วินาที
        setInterval(checkServerConnection, 30000);

        // ล้างทรัพยากร GPS เมื่อปิดหน้า
        window.addEventListener('beforeunload', function() {
            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
            }
        });
    </script>
    
    <!-- LIFF SDK (สำหรับ LINE) -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</body>
</html>
