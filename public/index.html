<!DOCTYPE html>
<html lang="th">
<head>    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-1797172064583364">
    <link rel="icon" href="https://www.huana-nbp.go.th/index/add_file/P0D284NMon35557.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- ****** Auto Complete ********* -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/ui-lightness/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1797172064583364"
         crossorigin="anonymous"></script>

    <title>ระบบลงเวลาออนไลน์ อบต.ข่าใหญ่</title>

    <!-- ****** Style CSS ********* -->
    <style>
        input#employee {
            width: 282px;
            height: 60px;
            background-color: brown;
            color: yellow;
            margin-block-start: 5px;
            border-radius: 36px;
            font-size: 20px;
        }

        div#showtxt {
            font-size: 27px;
            margin-top: 20px;
        }

        @font-face {
            font-family: 'Digital dream Fat';
            src: url('https://semicon.github.io/fonts/DigitaldreamFat.woff2') format('woff2'),
                 url('https://semicon.github.io/fonts/DigitaldreamFat.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        @import url('https://fonts.googleapis.com/css2?family=K2D&family=Kanit&family=Sriracha&display=swap');

        * {
            margin: 0px;
            padding: 0px;
            box-sizing: border-box;
            font-family: 'K2D', sans-serif;
        }

        body {
            font-family: 'Kanit', sans-serif;
            color: #444;
            background-color: white;
            padding: 20px;
            border: 2px solid white;
            box-shadow: 0px 8px 10px rgba(0, 0, 0, 0.5);
            font-size: 1.05rem;            min-height: 100vh;
            display: grid;
            place-items: center;
            background-color: #f8f9fa;
            background: url("./background.jpg") no-repeat center center;
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: cover;
        }

        input#employee {
            font-family: 'Kanit', sans-serif;
            width: 282px;
            height: 60px;
            background-color: brown;
            color: yellow;
            margin-block-start: 5px;
            border-radius: 36px;
            font-size: 20px;
        }

        .site-logo {
            content: url("https://www.huana-nbp.go.th/index/add_file/P0D284NMon35557.png");
            display: inline-block;
            margin-top: 20px;
            width: auto;
            height: 100px;
        }

        .msgBg {
            background-color: transparent;
        }

        .wrapper {
            background: rgba(221, 255, 255, 0.7);
            width: 350px;
            padding: 20px;
            border: 1px solid #999;
            border-radius: 5px;
            box-shadow: 0px 15px 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /** #### digital clock #### **/
        .clock {
            font-family: Digital dream Fat;
            font-size: 28px;
            color: #00f6fa;
            letter-spacing: 3px;
            text-shadow: 1px 1px 2px teal, 0 0 25px green, 0 0 5px #00fbff;
            min-width: 98%;
            background: #444;
            padding: 5px 0px 5px 10px;
            display: inline-block;
            border: 3px solid #ccc;
            border-radius: 2px;
            outline-style: solid;
            outline-color: #999;
        }

        /* ===== ไฟสถานะมุมขวาบน ===== */
        .status-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .status-online {
            background: linear-gradient(45deg, #28a745, #20c997);
            box-shadow: 
                0 0 20px rgba(40, 167, 69, 0.6),
                0 0 40px rgba(40, 167, 69, 0.4),
                inset 0 1px 3px rgba(255, 255, 255, 0.3);
            animation: smooth-pulse-green 2s ease-in-out infinite;
        }

        .status-offline {
            background: linear-gradient(45deg, #dc3545, #e74c3c);
            box-shadow: 
                0 0 20px rgba(220, 53, 69, 0.6),
                0 0 40px rgba(220, 53, 69, 0.4),
                inset 0 1px 3px rgba(255, 255, 255, 0.3);
            animation: smooth-pulse-red 2s ease-in-out infinite;
        }

        .status-connecting {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            box-shadow: 
                0 0 20px rgba(255, 193, 7, 0.6),
                0 0 40px rgba(255, 193, 7, 0.4),
                inset 0 1px 3px rgba(255, 255, 255, 0.3);
            animation: smooth-pulse-yellow 1s ease-in-out infinite;
        }

        /* สมูท animations */
        @keyframes smooth-pulse-green {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 
                    0 0 20px rgba(40, 167, 69, 0.6),
                    0 0 40px rgba(40, 167, 69, 0.4),
                    inset 0 1px 3px rgba(255, 255, 255, 0.3);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.1);
                box-shadow: 
                    0 0 30px rgba(40, 167, 69, 0.8),
                    0 0 60px rgba(40, 167, 69, 0.6),
                    inset 0 1px 3px rgba(255, 255, 255, 0.3);
            }
        }

        @keyframes smooth-pulse-red {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 
                    0 0 20px rgba(220, 53, 69, 0.6),
                    0 0 40px rgba(220, 53, 69, 0.4),
                    inset 0 1px 3px rgba(255, 255, 255, 0.3);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.1);
                box-shadow: 
                    0 0 30px rgba(220, 53, 69, 0.8),
                    0 0 60px rgba(220, 53, 69, 0.6),
                    inset 0 1px 3px rgba(255, 255, 255, 0.3);
            }
        }

        @keyframes smooth-pulse-yellow {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 
                    0 0 20px rgba(255, 193, 7, 0.6),
                    0 0 40px rgba(255, 193, 7, 0.4),
                    inset 0 1px 3px rgba(255, 255, 255, 0.3);
            }
            50% { 
                opacity: 0.8; 
                transform: scale(1.15);
                box-shadow: 
                    0 0 30px rgba(255, 193, 7, 0.8),
                    0 0 60px rgba(255, 193, 7, 0.6),
                    inset 0 1px 3px rgba(255, 255, 255, 0.3);
            }
        }        /* Hover effect สำหรับไฟ */
        .status-indicator:hover {
            transform: scale(1.2);
            transition: transform 0.2s ease;
        }

        /* Ad Modal Styles */
        .ad-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .ad-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .ad-timer {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }        .ad-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 14px;
            cursor: pointer;
            display: none;
        }

        .ad-close-btn:hover {
            background: #c82333;
        }

        .success-message {
            margin-bottom: 15px;
            padding: 10px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            border-radius: 5px;
            font-size: 16px;
        }

        .ad-container {
            margin: 15px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .version-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 10px;
            border-radius: 15px;
        }

        /* Autocomplete UI Styles */
        .ui-autocomplete {
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Kanit', sans-serif;
            font-size: 16px;
            z-index: 9999 !important;
        }

        .ui-menu-item {
            padding: 8px 12px;
        }

        .ui-menu-item:hover {
            background-color: #e3f2fd;
        }

        .ui-state-active,
        .ui-widget-content .ui-state-active {
            background: #2196f3;
            color: white;
            border: 1px solid #1976d2;
        }
    </style>
</head>

<!-- ******* Time Tracker HTML Body *********** -->
<body>
    <div class="wrapper text-center" style="max-width:350px">
        <!-- ไฟสถานะมุมขวาบน -->
        <div id="status-indicator" class="status-indicator status-connecting" title="สถานะการเชื่อมต่อ"></div>
        
        <div class="site-logo text-center"></div>
        <h5>ระบบลงเวลาออนไลน์ อบต.ข่าใหญ่</h5>

        <span id="MyClockDisplay" class="clock mt-3" onload="showTime()"></span>

        <form id="myForm">
            <div class="row mt-4">
                <div class="form-group col">
                    <label for="employee">พิมพ์ชื่อหรือรหัส </label>
                    <input id="employee" class="text-center"> <br>
                </div>
            </div>

            <div class="row mt-4">
                <div class="form-group col">
                    <label for="lblinfo"><i class="fas fa-book-reader"></i> หมายเหตุ:ประชุม/กิจกรรม อื่นๆ</label>
                    <input type="search" class="form-control form-control-lg" id="userinfo" name="userinfo" list="list">
                    <datalist id="list">
                        <option value="ไปราชการ">ไปราชการ</option>
                        <option value="ลากิจ">ลากิจ</option>
                        <option value="ลาป่วย">ลาป่วย</option>
                        <option value="ลาคลอด">ลาคลอด</option>
                    </datalist>
                </div>
            </div>

            <div class="row mt-4 g-2">
                <div class="col-6">
                    <button id="clockin" type="button" class="btn btn-lg btn-primary w-100">Clock In</button>
                </div>
                <div class="col-6">
                    <button id="clockout" type="button" class="btn btn-lg btn-warning w-100">Clock Out</button>
                </div>
            </div>

            <div class="row mt-4">
                <div class="form-group col">
                    <div class="alert" role="alert" id="message"></div>
                </div>
            </div>
        </form>
    </div>    <!-- Version info -->
    <div class="version-info">
        <span id="app-version">v2.1.0</span> | 
        <span id="server-status">Songphon</span>
    </div>

    <!-- Ad Modal -->
    <div id="adModal" class="ad-modal">
        <div class="ad-modal-content">
            <div class="ad-timer" id="adTimer">10</div>
            <button class="ad-close-btn" id="adCloseBtn" onclick="closeAdModal()">×</button>
            
            <div class="success-message" id="successMessage">
                <!-- ข้อความสำเร็จจะแสดงที่นี่ -->
            </div>
            
            <div class="ad-container">
                <!-- Google AdSense Display Ad -->
                <ins class="adsbygoogle"
                     style="display:block; width:300px; height:250px;"
                     data-ad-client="ca-pub-1797172064583364"
                     data-ad-slot="1797172064583364"
                     data-ad-format="rectangle"></ins>
            </div>
            
            <div style="margin-top: 15px; font-size: 12px; color: #666;">
                โปรดรอ <span id="remainingTime">10</span> วินาที หรือคลิกปิดได้
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        // VConsole สำหรับ debug (เปิดเฉพาะ development)
        // var vConsole = new window.VConsole();
    </script>

    <!-- ******* Javascript *********** -->
    <script>
        // ===== Configuration =====
        var isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
        var apiUrl = isProduction ? 
            window.location.origin + '/api' : 
            'http://localhost:3000/api';
        
        var owner = 'องค์การบริหารส่วนตำบลข่าใหญ่';
        var connectionRetryCount = 0;
        var maxRetries = 3;

        // GPS Variables - ทำงานเบื้องหลัง
        var gps = null;
        var isGpsReady = false;
        var gpsWatchId = null;
        var hasRequestedPermission = false;

        console.log('🌐 API URL:', apiUrl);
        console.log('🏢 Environment:', isProduction ? 'Production' : 'Development');

        var profile;

        // ตรวจสอบการเชื่อมต่อกับ server
        async function checkServerConnection() {
            try {
                const response = await fetch(apiUrl + '/health');
                const data = await response.json();
                
                if (response.ok && data.status === 'healthy') {
                    updateConnectionStatus('online');
                    connectionRetryCount = 0;
                    return true;
                } else {
                    throw new Error('Server unhealthy');
                }
            } catch (error) {
                console.error('❌ Connection check failed:', error);
                updateConnectionStatus('offline');
                
                if (connectionRetryCount < maxRetries) {
                    connectionRetryCount++;
                    setTimeout(checkServerConnection, 5000);
                    updateConnectionStatus('connecting');
                }
                
                return false;
            }
        }

        // ฟังก์ชันอัพเดทสถานะไฟ - แค่เปลี่ยนสี ไม่มีข้อความ
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('status-indicator');
            
            // ลบ class เก่าทั้งหมด
            indicator.classList.remove('status-online', 'status-offline', 'status-connecting');
            
            // เพิ่ม class ใหม่
            indicator.classList.add(`status-${status}`);
            
            // อัพเดท tooltip
            const statusText = {
                online: 'เชื่อมต่อแล้ว',
                offline: 'ไม่สามารถเชื่อมต่อได้',
                connecting: 'กำลังเชื่อมต่อ...'
            };
            
            indicator.title = statusText[status] || 'ไม่ทราบสถานะ';
            
            console.log(`🔘 Status updated: ${status}`);
        }

        // ======== GPS Functions - ทำงานเบื้องหลัง ========
        function initializeGPS() {
            console.log('📍 Initializing GPS silently...');

            if (!navigator.geolocation) {
                console.warn('❌ Geolocation not supported');
                getFallbackLocation();
                return;
            }

            // ลองขอตำแหน่งแบบเงียบๆ
            const gpsOptions = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            };

            navigator.geolocation.getCurrentPosition(
                onGpsSuccess,
                onGpsError,
                gpsOptions
            );

            // เริ่ม watch position
            gpsWatchId = navigator.geolocation.watchPosition(
                onGpsUpdate,
                onGpsError,
                {
                    enableHighAccuracy: true,
                    timeout: 8000,
                    maximumAge: 30000
                }
            );
        }

        function onGpsSuccess(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            gps = [lat, lon];
            isGpsReady = true;
            
            console.log(`✅ GPS Ready: ${lat}, ${lon} (accuracy: ${Math.round(accuracy)}m)`);
        }

        function onGpsUpdate(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            gps = [lat, lon];
            console.log(`📍 GPS Updated: ${lat}, ${lon}`);
        }

        function onGpsError(error) {
            console.warn('⚠️ GPS Error:', error.code, error.message);
            
            // ถ้ายังไม่เคยขออนุญาตและเป็น PERMISSION_DENIED
            if (error.code === error.PERMISSION_DENIED && !hasRequestedPermission) {
                // ไม่ทำอะไร ปล่อยให้ fallback ทำงาน
                console.log('📍 Permission denied, will use fallback when needed');
            }
            
            // ลองใช้วิธีอื่น
            setTimeout(getFallbackLocation, 1000);
        }

        function getFallbackLocation() {
            console.log('🔄 Using fallback location methods...');
            
            // วิธีที่ 1: URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const urlLat = urlParams.get('lat');
            const urlLon = urlParams.get('lon');
            
            if (urlLat && urlLon) {
                gps = [parseFloat(urlLat), parseFloat(urlLon)];
                isGpsReady = true;
                console.log('📍 Using URL location:', gps);
                return;
            }
            
            // วิธีที่ 2: IP Geolocation
            fetch('https://ipapi.co/json/')
                .then(response => response.json())
                .then(data => {
                    if (data.latitude && data.longitude) {
                        gps = [data.latitude, data.longitude];
                        isGpsReady = true;
                        console.log('📍 Using IP location:', gps);
                    } else {
                        throw new Error('No location from IP');
                    }
                })
                .catch(error => {
                    console.warn('⚠️ IP location failed:', error);
                    
                    // วิธีที่ 3: Default location (อบต.ข่าใหญ่)
                    gps = [14.0583, 100.6014];
                    isGpsReady = true;
                    console.log('📍 Using default location:', gps);
                });
        }

        // ======== SweetAlert2 GPS Permission ========
        async function requestGPSPermission() {
            hasRequestedPermission = true;
            
            const result = await Swal.fire({
                title: '📍 ขออนุญาตใช้ตำแหน่ง',
                text: 'ระบบต้องการเข้าถึงตำแหน่งของคุณเพื่อบันทึกการลงเวลา',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'อนุญาต',
                cancelButtonText: 'ไม่อนุญาต',
                allowOutsideClick: false
            });

            if (result.isConfirmed) {
                // แสดง loading
                Swal.fire({
                    title: 'กำลังค้นหาตำแหน่ง...',
                    html: 'โปรดรอสักครู่',
                    timer: 5000,
                    timerProgressBar: true,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    allowOutsideClick: false
                });

                // ขอตำแหน่งด้วยการตั้งค่าที่แม่นยำ
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        
                        gps = [lat, lon];
                        isGpsReady = true;
                        
                        console.log(`✅ GPS Permission granted: ${lat}, ${lon}`);
                        
                        Swal.fire({
                            title: 'สำเร็จ!',
                            text: `พบตำแหน่งแล้ว (แม่นยำ ${Math.round(accuracy)} เมตร)`,
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    },
                    (error) => {
                        console.error('❌ GPS Permission error:', error);
                        
                        Swal.fire({
                            title: 'ไม่สามารถหาตำแหน่งได้',
                            text: 'ระบบจะใช้ตำแหน่งโดยประมาณ',
                            icon: 'warning',
                            timer: 3000,
                            showConfirmButton: false
                        });
                        
                        getFallbackLocation();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            } else {
                // ผู้ใช้ไม่อนุญาต
                Swal.fire({
                    title: 'ใช้ตำแหน่งโดยประมาณ',
                    text: 'ระบบจะใช้ตำแหน่งเริ่มต้น',
                    icon: 'info',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                getFallbackLocation();
            }
        }

        // ======== Ad Modal Functions ========
        let adTimer = null;
        let adTimeRemaining = 10;        function showAdModal(successMessage) {
            // แสดงข้อความสำเร็จ
            document.getElementById('successMessage').innerHTML = successMessage;
            
            // แสดง modal
            document.getElementById('adModal').style.display = 'block';
            
            // รีเซ็ตตัวจับเวลา
            adTimeRemaining = 10;
            document.getElementById('adTimer').textContent = adTimeRemaining;
            document.getElementById('remainingTime').textContent = adTimeRemaining;
            
            // แสดง timer และซ่อนปุ่มปิด
            document.getElementById('adTimer').style.display = 'block';
            document.getElementById('adCloseBtn').style.display = 'none';
              // เริ่มจับเวลา
            adTimer = setInterval(() => {
                adTimeRemaining--;
                document.getElementById('adTimer').textContent = adTimeRemaining;
                document.getElementById('remainingTime').textContent = adTimeRemaining;
                
                if (adTimeRemaining <= 0) {
                    clearInterval(adTimer);
                    // ซ่อน timer และแสดงปุ่มปิดแทน
                    document.getElementById('adTimer').style.display = 'none';
                    document.getElementById('adCloseBtn').style.display = 'block';
                    document.getElementById('remainingTime').textContent = '0';
                }
            }, 1000);
            
            // โหลดโฆษณา
            try {
                (adsbygoogle = window.adsbygoogle || []).push({});
                console.log('📺 AdSense ad loaded');
            } catch (error) {
                console.warn('⚠️ AdSense error:', error);
            }
        }

        function closeAdModal() {
            // ล้างตัวจับเวลา
            if (adTimer) {
                clearInterval(adTimer);
                adTimer = null;
            }
            
            // ปิด modal
            document.getElementById('adModal').style.display = 'none';
            
            console.log('📺 Ad modal closed');
        }

        // ปิด modal เมื่อคลิกนอกพื้นที่
        window.onclick = function(event) {
            const modal = document.getElementById('adModal');
            if (event.target === modal && adTimeRemaining <= 0) {
                closeAdModal();
            }
        }

        // ======== Enhanced Clock In/Out Functions ========
        async function ClockIn() {
            event.preventDefault();
            
            var employee = document.getElementById("employee").value;
            var userinfo = document.getElementById("userinfo").value;

            if (employee != '') {
                // ตรวจสอบ GPS - ถ้าไม่พร้อมให้ขออนุญาต
                if (!isGpsReady || !gps) {
                    console.log('📍 GPS not ready, requesting permission...');
                    await requestGPSPermission();
                    
                    // ถ้ายังไม่พร้อมให้รอ
                    if (!isGpsReady || !gps) {
                        $('#message').html('⚠️ ไม่สามารถระบุตำแหน่งได้ กรุณาลองใหม่');
                        document.getElementById("message").className = "alert alert-warning";
                        return;
                    }
                }

                $('#message').html("<span class='spinner-border spinner-border-sm text-primary'></span> โปรดรอสักครู่ ...!");
                
                try {
                    if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                        profile = liff.getDecodedIDToken();
                    }

                    console.log('⏰ Sending Clock In request:', {
                        employee,
                        userinfo,
                        lat: gps[0],
                        lon: gps[1]
                    });

                    const response = await fetch(apiUrl + '/clockin', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            employee,
                            userinfo,
                            lat: gps[0],
                            lon: gps[1],
                            line_name: profile ? profile.name : 'ผู้ใช้งาน',
                            line_picture: profile ? profile.picture : ''
                        })
                    });

                    const result = await response.json();
                    console.log('⏰ Clock In result:', result);
                      if (result.success) {
                        setTimeout(() => {
                            var message = result.employee + '<br> บันทึกเวลามา ' + result.time;
                            $('#message').html(message);
                            document.getElementById("message").className = "alert alert-primary";
                            
                            // แสดงโฆษณา
                            showAdModal(`
                                <strong>✅ ลงเวลาเข้าสำเร็จ!</strong><br>
                                <div style="margin-top: 10px;">
                                    <strong>${result.employee}</strong><br>
                                    เวลาเข้า: <strong>${result.time}</strong>
                                </div>
                            `);
                            
                            clearForm();
                        }, 500);
                    } else {
                        var message = result.employee + ' ' + result.message;
                        $('#message').html(message);
                        document.getElementById("message").className = "alert alert-warning";
                        clearForm();
                    }

                } catch (error) {
                    console.error('❌ Clock in error:', error);
                    $('#message').html('⚠️ เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง');
                    document.getElementById("message").className = "alert alert-danger";
                    clearForm();
                }
            } else {
                $('#message').html('⚠️ กรุณาเลือกรายชื่อพนักงาน ...!');
                document.getElementById('message').className = 'alert alert-warning text-danger';
                clearForm();
            }
        }

        async function ClockOut() {
            event.preventDefault();
            
            var employee = document.getElementById("employee").value;

            if (employee != '') {
                // ตรวจสอบ GPS - ถ้าไม่พร้อมให้ขออนุญาต
                if (!isGpsReady || !gps) {
                    console.log('📍 GPS not ready, requesting permission...');
                    await requestGPSPermission();
                    
                    // ถ้ายังไม่พร้อมให้รอ
                    if (!isGpsReady || !gps) {
                        $('#message').html('⚠️ ไม่สามารถระบุตำแหน่งได้ กรุณาลองใหม่');
                        document.getElementById("message").className = "alert alert-warning";
                        return;
                    }
                }

                $('#message').html("<span class='spinner-border spinner-border-sm text-warning'></span> โปรดรอสักครู่ ...!");
                
                try {
                    if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                        profile = liff.getDecodedIDToken();
                    }

                    console.log('⏰ Sending Clock Out request:', {
                        employee,
                        lat: gps[0],
                        lon: gps[1]
                    });

                    const response = await fetch(apiUrl + '/clockout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            employee,
                            lat: gps[0],
                            lon: gps[1],
                            line_name: profile ? profile.name : 'ผู้ใช้งาน',
                            line_picture: profile ? profile.picture : ''
                        })
                    });

                    const result = await response.json();
                    console.log('⏰ Clock Out result:', result);
                      if (result.success) {
                        setTimeout(() => {
                            var message = result.employee + '<br> บันทึกเวลากลับ ' + result.time;
                            if (result.hours) {
                                message += '<br>ทำงานรวม ' + result.hours + ' ชั่วโมง';
                            }
                            $('#message').html(message);
                            document.getElementById("message").className = "alert alert-primary";
                            
                            // แสดงโฆษณา
                            let adMessage = `
                                <strong>✅ ลงเวลาออกสำเร็จ!</strong><br>
                                <div style="margin-top: 10px;">
                                    <strong>${result.employee}</strong><br>
                                    เวลาออก: <strong>${result.time}</strong>
                            `;
                            
                            if (result.hours) {
                                adMessage += `<br>ทำงานรวม: <strong>${result.hours} ชั่วโมง</strong>`;
                            }
                            
                            adMessage += `</div>`;
                            
                            showAdModal(adMessage);
                            
                            clearForm();
                        }, 500);
                    } else {
                        var message = result.employee + ' ' + result.message;
                        $('#message').html(message);
                        document.getElementById("message").className = "alert alert-warning";
                        clearForm();
                    }

                } catch (error) {
                    console.error('❌ Clock out error:', error);
                    $('#message').html('⚠️ เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง');
                    document.getElementById("message").className = "alert alert-danger";
                    clearForm();
                }
            } else {
                $('#message').html("⚠️ กรุณาเลือกรายชื่อพนักงาน ...!");
                document.getElementById("message").className = "alert alert-warning text-danger";
                clearForm();
            }
        }

        $(document).ready(function () {
            let profile = null;

            // เริ่มระบบ GPS เบื้องหลังทันที
            initializeGPS();

            // ตรวจสอบการเชื่อมต่อ
            checkServerConnection();

            $('#clockin').click(() => ClockIn());
            $('#clockout').click(() => ClockOut());

            // เช็คว่ามี LIFF ไหม (สำหรับ LINE)
            if (typeof liff !== 'undefined') {
                liff.init({
                   // liffId: '2000498666-QpjPNOd6',
                    withLoginOnExternalBrowser: true
                });

                liff.ready.then(() => {
                    profile = liff.getDecodedIDToken();

                    if (profile) {
                        console.log("🚀 LINE Profile loaded:", profile.name);
                    } else {
                        console.log("⚠️ No LINE profile available");
                    }

                    initApp();
                });
            } else {
                console.log("⚠️ LIFF not available, using fallback");
                profile = {
                    name: 'ผู้ใช้งาน',
                    picture: ''
                };
                initApp();
            }

            function initApp() {
                document.getElementById('message').innerText = owner;
                document.getElementById('message').className = 'alert msgBg';
                
                // รอให้ jQuery UI โหลดเสร็จก่อนโหลดข้อมูลพนักงาน
                console.log('🔧 Initializing app...');
                console.log('📚 jQuery version:', $.fn.jquery);
                console.log('📚 jQuery UI loaded:', typeof $.fn.autocomplete !== 'undefined');
                
                // รอสักครู่แล้วค่อยโหลดข้อมูลพนักงาน
                setTimeout(() => {
                    loadEmployees();
                }, 500);
            }
        });

        async function loadEmployees() {
            try {
                console.log('👥 Loading employees...');
                
                const response = await fetch(apiUrl + '/employees', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('📊 Employee data received:', data);
                
                if (data.success && data.data && Array.isArray(data.data)) {
                    var dataPerson = data.data;
                    console.log('👥 Employees loaded successfully:', dataPerson.length, 'employees');
                    console.log('📋 Sample employees:', dataPerson.slice(0, 3));
                    
                    // ตรวจสอบว่า jQuery UI พร้อมใช้งานแล้ว
                    if (typeof $.fn.autocomplete === 'undefined') {
                        console.error('❌ jQuery UI Autocomplete not loaded');
                        return;
                    }
                    
                    // ตั้งค่า Autocomplete
                    $("#employee").autocomplete({
                        source: dataPerson,
                        minLength: 1, // แสดงผลเมื่อพิมพ์อย่างน้อย 1 ตัวอักษร
                        maxShowItems: 5, // แสดงสูงสุด 5 รายการ
                        autoFocus: true, // เลือกรายการแรกอัตโนมัติ
                        delay: 300, // หน่วงเวลา 300ms
                        select: function(event, ui) {
                            // เมื่อเลือกชื่อแล้ว
                            console.log('👤 Selected employee:', ui.item.value);
                        },
                        search: function(event, ui) {
                            console.log('🔍 Searching for:', this.value);
                        },
                        response: function(event, ui) {
                            console.log('📋 Search results:', ui.content.length, 'items');
                        }
                    });
                    
                    console.log('✅ Autocomplete initialized successfully');
                    
                    // ทดสอบ Autocomplete
                    const testInput = $("#employee");
                    if (testInput.length > 0) {
                        console.log('✅ Employee input field found');
                    } else {
                        console.error('❌ Employee input field not found');
                    }
                    
                } else {
                    throw new Error(data.error || 'Invalid employee data format');
                }

            } catch (error) {
                console.error('❌ Failed to load employees:', error);
                $('#message').html('⚠️ ไม่สามารถโหลดรายชื่อพนักงานได้: ' + error.message);
                document.getElementById("message").className = "alert alert-warning";
                
                // ลองใช้ข้อมูลตัวอย่างถ้าโหลดไม่ได้
                console.log('🔄 Using sample employee data for testing...');
                const sampleEmployees = [
                    'นายสมชาย ใจดี',
                    'นางสาวสมใส รักงาน', 
                    'นายวิชัย ขยันดี',
                    'นางมณี สุภาพ',
                    'นายกิตติ มั่นใจ'
                ];
                
                $("#employee").autocomplete({
                    source: sampleEmployees,
                    minLength: 1,
                    maxShowItems: 5,
                    autoFocus: true
                });
                
                console.log('✅ Sample autocomplete initialized');
            }
        }

        function clearForm() {
            setTimeout(function () {
                document.getElementById('message').innerText = owner;
                document.getElementById("message").className = "alert msgBg";
                document.getElementById("myForm").reset();
            }, 5000);
        }

        /** จาวาสคริปต์ นาฬิกาดิจิตอล **/
        function showTime() {
            var date = new Date();
            var h = date.getHours();
            var m = date.getMinutes();
            var s = date.getSeconds();
            var dot = document.textContent = '.';

            if (s % 2 == 1) {
                dot = document.textContent = '.';
            } else {
                dot = document.textContent = '\xa0';
            }

            h = h < 10 ? "0" + h : h;
            m = m < 10 ? "0" + m : m;
            s = s < 10 ? "0" + s : s;

            var time = h + ":" + m + ":" + s + '' + dot;
            document.getElementById("MyClockDisplay").innerText = time;
            document.getElementById("MyClockDisplay").textContent = time;

            setTimeout(showTime, 1000);
        }

        // เริ่มต้นการทำงาน
        showTime();
        
        // ตรวจสอบการเชื่อมต่อทุก 30 วินาที
        setInterval(checkServerConnection, 30000);

        // ล้างทรัพยากร GPS เมื่อปิดหน้า
        window.addEventListener('beforeunload', function() {
            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
            }
        });
    </script>
    
    <!-- LIFF SDK (สำหรับ LINE) -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</body>
</html>
