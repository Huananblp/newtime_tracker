<!--  *********** Time Tracker V.11 - ข่าใหญ่ *****************  -->
<!--  ******* Ref. https://codewithcurt.com/create-employee-time-clock-web-app-on-google-sheets/ ****  -->

<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="icon" href="https://www.huana-nbp.go.th/index/add_file/qOv0r0dTue83729.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <!-- ****** Auto Complete ********* -->
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/jquery-ui.autocomplete.scroll@0.1.9/jquery.ui.autocomplete.scroll.min.js"></script>

  <!-- ****** Style CSS ********* -->
  <style>
    input#employee {
      width: 282px;
      height: 60px;
      background-color: brown;
      color: yellow;
      margin-block-start: 5px;
      border-radius: 36px;
      font-size: 20px;
    }

    div#showtxt {
      font-size: 27px;
      margin-top: 20px;
    }
    
    @font-face {
      font-family: 'Digital dream Fat';
      src: url('https://semicon.github.io/fonts/DigitaldreamFat.woff2') format('woff2'),
        url('https://semicon.github.io/fonts/DigitaldreamFat.woff') format('woff');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    @import url('https://fonts.googleapis.com/css2?family=K2D&family=Kanit&family=Sriracha&display=swap');

    * {
      margin: 0px;
      padding: 0px;
      box-sizing: border-box;
      font-family: 'K2D', sans-serif;
    }

    body {
    font-family: 'Kanit', sans-serif;
    color: #444;
    background-color: white;
    padding: 20px;
    border: 2px solid white;
    box-shadow: 0px 8px 10px rgba(0, 0, 0, 0.5);
    font-size: 1.05rem;
    min-height: 100vh;
    display: grid;
    place-items: center;
    background-color: #92a8d1;
    background: url("https://www.i-pic.info/i/BbiN536436.jpg") no-repeat center center fixed;
    -webkit-background-size: cover;
    -moz-background-size: cover;
    -o-background-size: cover;
    background-size: cover;
    }

    input#employee {
     font-family: 'Kanit', sans-serif;
     width: 282px;
     height: 60px;
     background-color: brown;
     color: yellow;
     margin-block-start: 5px;
     border-radius: 36px;
     font-size: 20px;
   }

    .site-logo {
      content: url("https://www.huana-nbp.go.th/index/add_file/qOv0r0dTue83729.png");
      display: inline-block;
      margin-top: 20px;
      width: auto;
      height: 100px;
    }

    .msgBg {
      background-color: transparent;
    }

    .wrapper {
    background: rgba(221, 255, 255, 0.7);
    width: 350px;
    padding: 20px;
    border: 1px solid #999;
    border-radius: 5px;
    box-shadow: 0px 15px 20px rgba(0, 0, 0, 0.1);
    }

    /** #### digital clock #### **/
    .clock {
      font-family: Digital dream Fat;
      font-size: 28px;
      color: #00f6fa;
      letter-spacing: 3px;
      text-shadow: 1px 1px 2px teal, 0 0 25px green, 0 0 5px #00fbff;
      min-width: 98%;
      background: #444;
      padding: 5px 0px 5px 10px;
      display: inline-block;
      border: 3px solid #ccc;
      border-radius: 2px;
      outline-style: solid;
      outline-color: #999;
    }

    /** #### Queue Status Styles #### **/
    .queue-status {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 12px;
      margin-top: 5px;
      text-align: center;
      font-weight: bold;
    }

    .queue-idle {
      background-color: #d4edda;
      color: #155724;
    }

    .queue-processing {
      background-color: #fff3cd;
      color: #856404;
    }

    .queue-busy {
      background-color: #f8d7da;
      color: #721c24;
    }

    .loading-dots {
      display: inline-block;
      position: relative;
    }

    .loading-dots::after {
      content: '...';
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .processing-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .processing-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .btn-disabled {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>

</head>

<body>
  <!-- Processing Overlay -->
  <div id="processingOverlay" class="processing-overlay">
    <div class="processing-content">
      <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h5 id="processingText">กำลังประมวลผล...</h5>
      <p id="processingDetail" class="text-muted mb-0"></p>
    </div>
  </div>

  <div class="wrapper text-center" style="max-width:350px">
    <div class="site-logo text-center"></div>
    <h5>ระบบลงเวลาออนไลน์ อบต.ข่าใหญ่</h5>
    <div id="queueStatus" class="queue-status queue-idle">ระบบพร้อมใช้งาน</div>

    <span id="MyClockDisplay" class="clock mt-3" onload="showTime()"></span>

    <form id="myForm">

      <div class="row mt-4">
        <div class="form-group col">
          <label for="employee">พิมพ์ชื่อหรือรหัส </label>
          <input id="employee" class="text-center"> <br>
        </div>
      </div>

      <div class="row mt-4">
        <div class="form-group col">
          <label for="lblinfo"><i class="fas fa-book-reader"></i> หมายเหตุ:ประชุม/กิจกรรม อื่นๆ</label>
          <input type="search" class="form-control form-control-lg" id="userinfo" name="userinfo" list="list">
          <datalist id="list">
            <option value="ไปราชการ">ไปราชการ</option>
            <option value="ลากิจ">ลากิจ</option>
            <option value="ลาป่วย">ลาป่วย</option>
            <option value="ลาคลอด">ลาคลอด</option>
          </datalist>
        </div>
      </div>

      <div class="row mt-4 g-2">
        <div class="col-6">
          <button id="clockin" type="button" class="btn btn-lg btn-primary w-100">Clock In</button>
        </div>
        <div class="col-6">
          <button id="clockout" type="button" class="btn btn-lg btn-warning w-100">Clock Out</button>
        </div>
      </div>

      <div class="row mt-2">
        <div class="col-12">
          <button id="createSheets" type="button" class="btn btn-sm btn-secondary w-100">สร้าง Sheets ใหม่</button>
        </div>
      </div>

      <div class="row mt-4">
        <div class="form-group col">
          <div class="alert" role="alert" id="message"></div>
        </div>
      </div>

    </form>
  </div>

  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <script>
    // var vConsole = new window.VConsole();
  </script>

  <script>
    var scripturl = 'https://script.google.com/macros/s/AKfycbz1fErVaxzVX-6YFD7Q7X_EfwkApE4G8PdPjTK3zqRUbj1GVeFXyuQMFOCr-1_V022c/exec'
    var owner = 'องค์การบริหารส่วนตำบลข่าใหญ่';
    var profile, gps;
    var queueCheckInterval;
    var isProcessing = false;

    // Queue Management
    function showProcessingOverlay(text, detail = '') {
      $('#processingText').text(text);
      $('#processingDetail').text(detail);
      $('#processingOverlay').show();
      $('.btn').addClass('btn-disabled');
      isProcessing = true;
    }

    function hideProcessingOverlay() {
      $('#processingOverlay').hide();
      $('.btn').removeClass('btn-disabled');
      isProcessing = false;
    }

    function updateQueueStatus(status) {
      const queueEl = $('#queueStatus');
      
      if (status.totalInQueue === 0 && status.processing === 0) {
        queueEl.removeClass('queue-processing queue-busy').addClass('queue-idle');
        queueEl.text('ระบบพร้อมใช้งาน');
      } else if (status.processing > 0) {
        queueEl.removeClass('queue-idle queue-busy').addClass('queue-processing');
        queueEl.text(`กำลังประมวลผล ${status.processing} รายการ`);
      } else {
        queueEl.removeClass('queue-idle queue-processing').addClass('queue-busy');
        queueEl.text(`คิว ${status.totalInQueue} รายการ`);
      }
    }

    function startQueueMonitoring() {
      queueCheckInterval = setInterval(() => {
        if (!isProcessing) {
          $.ajax({
            method: "POST",
            url: scripturl,
            data: { opt: 'queuestatus' },
            success: function(status) {
              updateQueueStatus(status);
            },
            error: function() {
              console.log("Queue status check failed");
            }
          });
        }
      }, 2000);
    }

    function stopQueueMonitoring() {
      if (queueCheckInterval) {
        clearInterval(queueCheckInterval);
      }
    }

    $.when(getlocation()).done(function (res) {
      console.log(res)
      console.log(gps)
    });

    $(document).ready(function () {
      let profile = null;

      $('#clockin').click(() => ClockIn());
      $('#clockout').click(() => ClockOut());
      $('#createSheets').click(() => CreateSheets());

      liff.init({
        liffId: '2000498666-QpjPNOd6',
        withLoginOnExternalBrowser: true
      });

      liff.ready.then(() => {
        profile = liff.getDecodedIDToken();

        if (profile) {
          console.log("🚀 ~ profile:", profile);
          console.log("User ID (sub): " + profile.sub);
          console.log("Display Name (name): " + profile.name);
          console.log("Email: " + (profile.email || "ไม่พบอีเมล"));
          console.log("Picture URL: " + (profile.picture || "ไม่พบรูปโปรไฟล์"));
        } else {
          console.log("โปรไฟล์ยังไม่พร้อมใช้งานหรือไม่มีข้อมูลโปรไฟล์");
        }

        initApp();
        startQueueMonitoring();
      });

      function initApp() {
        document.getElementById('message').innerText = owner;
        document.getElementById('message').className = 'alert msgBg';
        
        $.ajax({
          method: "POST",
          url: scripturl,
          data: {
            opt: 'getdata',
          },
          success: function (dataPerson) {
            console.log(dataPerson)
            $(function () {
              var availableTags = dataPerson
              $("#employee").autocomplete({
                maxShowItems: 3,
                source: availableTags
              });
            });
          },
          error: function() {
            console.log("Failed to load employee data");
          }
        })

        getEmployees()
      }
    });

    function getEmployees() {
      $.ajax({
        method: "POST",
        url: scripturl,
        data: {
          opt: 'getemployee',
        },
        success: function (ar) {
          var employeeSelect = document.getElementById("employee");

          let option = document.createElement("option");
          option.value = "";
          option.text = "";
          employeeSelect.appendChild(option);

          ar.forEach(function (item, index) {
            let option = document.createElement("option");
            var employee = item[0];
            option.value = item[0];
            option.text = item[0];
            employeeSelect.appendChild(option);
          });
        },
        error: function() {
          console.log("Failed to load employees");
        }
      })
    }

    function CreateSheets() {
      if (isProcessing) return;
      
      showProcessingOverlay('กำลังสร้าง Sheets...', 'กรุณารอสักครู่');
      
      $.ajax({
        method: 'POST',
        url: scripturl,
        data: {
          opt: 'createsheets'
        },
        success: function (res) {
          hideProcessingOverlay();
          console.log(res);
          
          if (res.msg === 'SUCCESS') {
            $('#message').html('✅ สร้าง Sheets เรียบร้อยแล้ว<br><small>' + res.sheets.join(', ') + '</small>');
            document.getElementById("message").className = "alert alert-success";
            
            // รีเฟรชข้อมูลพนักงาน
            setTimeout(() => {
              getEmployees();
              clearForm();
            }, 2000);
          } else {
            $('#message').html('❌ เกิดข้อผิดพลาด: ' + res.error);
            document.getElementById("message").className = "alert alert-danger";
            clearForm();
          }
        },
        error: function() {
          hideProcessingOverlay();
          $('#message').html('❌ เกิดข้อผิดพลาดในการเชื่อมต่อ');
          document.getElementById("message").className = "alert alert-danger";
          clearForm();
        }
      });
    }

    async function ClockIn() {
      if (isProcessing) return;
      
      event.preventDefault()
      var employee = document.getElementById("employee").value;
      var userinfo = document.getElementById("userinfo").value;

      if (employee != '') {
        showProcessingOverlay('กำลังลงเวลาเข้างาน...', 'กรุณารอสักครู่');
        
        profile = liff.getDecodedIDToken();
        
        $.ajax({
        method: 'POST',
        url: scripturl,
        data: {
          opt: 'clockin',
          employee,
          userinfo,
          lat: gps[0],
          lon: gps[1],
          line_name: profile.name,
          line_picture: profile.picture
          },
          success: function (res) {
            console.log(res);
            
            if (res.msg === 'QUEUED') {
              hideProcessingOverlay();
              $('#message').html(`🕒 เข้าคิวแล้ว<br><small>ลำดับที่ ${res.position} - ${res.employee}</small>`);
              document.getElementById("message").className = "alert alert-info";
              
              // ตรวจสอบสถานะคิวจนกว่าจะเสร็จ
              checkQueueProgress(res.queueId, res.employee, 'เข้างาน');
              
            } else if (res.msg === 'SUCCESS') {
              hideProcessingOverlay();
              var message = res.employee + '<br> บันทึกเวลามา ' + res.return_date;
              $('#message').html(message);
              document.getElementById("message").className = "alert alert-primary";
              clearForm();
              
            } else {
              hideProcessingOverlay();
              var message = res.employee + ' ' + res.msg;
              $('#message').html(message);
              document.getElementById("message").className = "alert alert-warning";
              clearForm();
            }
          },
          error: function() {
            hideProcessingOverlay();
            $('#message').html('❌ เกิดข้อผิดพลาดในการเชื่อมต่อ');
            document.getElementById("message").className = "alert alert-danger";
            clearForm();
          }
        })

      } else {
        $('#message').html('กรุณาเลือกรายชื่อพนักงาน ...!');
        document.getElementById('message').className = 'alert alert-warning text-danger';
        clearForm();
      }
    }

    async function ClockOut() {
      if (isProcessing) return;
      
      event.preventDefault()
      var employee = document.getElementById("employee").value;

      if (employee != '') {
        showProcessingOverlay('กำลังลงเวลาออกงาน...', 'กรุณารอสักครู่');
        
        profile = liff.getDecodedIDToken();
        
        $.ajax({
          method: 'POST',
          url: scripturl,
          data: {
            opt: 'clockout',
            employee,
            lat: gps[0],
            lon: gps[1],
            line_name: profile.name,
            line_picture: profile.picture
          },
          success: function (res) {
            console.log(res);
            
            if (res.msg === 'QUEUED') {
              hideProcessingOverlay();
              $('#message').html(`🕒 เข้าคิวแล้ว<br><small>ลำดับที่ ${res.position} - ${res.employee}</small>`);
              document.getElementById("message").className = "alert alert-info";
              
              checkQueueProgress(res.queueId, res.employee, 'ออกงาน');
              
            } else if (res.msg === 'SUCCESS') {
              hideProcessingOverlay();
              var message = res.employee + '<br> บันทึกเวลากลับ ' + res.return_date;
              if (res.workingHours) {
                message += '<br><small>ทำงาน ' + res.workingHours + ' ชั่วโมง</small>';
              }
              $('#message').html(message);
              document.getElementById("message").className = "alert alert-primary";
              clearForm();
              
            } else {
              hideProcessingOverlay();
              var message = res.employee + ' ' + res.msg;
              $('#message').html(message);
              document.getElementById("message").className = "alert alert-warning";
              clearForm();
            }
          },
          error: function() {
            hideProcessingOverlay();
            $('#message').html('❌ เกิดข้อผิดพลาดในการเชื่อมต่อ');
            document.getElementById("message").className = "alert alert-danger";
            clearForm();
          }
        })

      } else {
        $('#message').html("กรุณาเลือกรายชื่อพนักงาน ...!");
        document.getElementById("message").className = "alert alert-warning text-danger";
        clearForm();
      }
    }

    function checkQueueProgress(queueId, employee, action) {
      let attempts = 0;
      const maxAttempts = 30; // 30 seconds max
      
      const progressCheck = setInterval(() => {
        attempts++;
        
        $.ajax({
          method: "POST",
          url: scripturl,
          data: { opt: 'queuestatus' },
          success: function(status) {
            updateQueueStatus(status);
            
            // หยุดตรวจสอบเมื่อไม่มีงานในคิวแล้ว หรือเกินเวลา
            if (status.totalInQueue === 0 && status.processing === 0) {
              clearInterval(progressCheck);
              $('#message').html(`✅ ลงเวลา${action}เรียบร้อยแล้ว<br><small>${employee}</small>`);
              document.getElementById("message").className = "alert alert-success";
              clearForm();
            } else if (attempts >= maxAttempts) {
              clearInterval(progressCheck);
              $('#message').html(`⏳ กำลังประมวลผล...<br><small>กรุณาตรวจสอบผลลัพธ์ในภายหลัง</small>`);
              document.getElementById("message").className = "alert alert-warning";
              clearForm();
            }
          },
          error: function() {
            if (attempts >= maxAttempts) {
              clearInterval(progressCheck);
            }
          }
        });
      }, 1000);
    }

    var geolocation
    function getlocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, getLocationFromApi);
      } else {
        console.log("Geolocation is not supported by this browser.")
      }
    }

    function showPosition(position) {
      var lat = position.coords.latitude;
      var lon = position.coords.longitude;
      gps = [lat, lon];
      console.log("🚀 ~ gps:", gps)
      console.log("Latitude: " + lat + " Longitude: " + lon);
    }

    function getLocationFromParameter() {
      var url = new URL(window.location.href);
      var lat = url.searchParams.get("lat");
      var lon = url.searchParams.get("lon");
      gps = [lat, lon];
      console.log("Latitude: " + lat + " Longitude: " + lon);
    }

    function getLocationFromApi() {
      $.getJSON('https://ipapi.co/json/', function (data) {
        var lat = data.latitude;
        var lon = data.longitude;
        gps = [lat, lon];
        console.log("Latitude: " + lat + " Longitude: " + lon);
        return geolocation
      });
    }

    function clearForm() {
      setTimeout(function () {
        document.getElementById('message').innerText = owner;
        document.getElementById("message").className = "alert msgBg";
        document.getElementById("myForm").reset();
      }, 5000);
    }

    function showTime() {
      var date = new Date();
      var h = date.getHours();
      var m = date.getMinutes();
      var s = date.getSeconds();
      var dot = document.textContent = '.';

      if (s % 2 == 1) {
        dot = document.textContent = '.';
      } else {
        dot = document.textContent = '\xa0';
      }

      h = h < 10 ? "0" + h : h;
      m = m < 10 ? "0" + m : m;
      s = s < 10 ? "0" + s : s;

      var time = h + ":" + m + ":" + s + '' + dot;
      document.getElementById("MyClockDisplay").innerText = time;
      document.getElementById("MyClockDisplay").textContent = time;

      setTimeout(showTime, 1000);
    }

    showTime();

    // ทำความสะอาดเมื่อปิดหน้า
    window.addEventListener('beforeunload', function() {
      stopQueueMonitoring();
    });

  </script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</body>

</html>
