<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://www.huana-nbp.go.th/index/add_file/P0D284NMon35557.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  
  <!-- Auto Complete -->
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery-ui.autocomplete.scroll@0.1.9/jquery.ui.autocomplete.scroll.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=K2D&family=Kanit&family=Sriracha&display=swap');
    
    @font-face {
      font-family: 'Digital dream Fat';
      src: url('https://semicon.github.io/fonts/DigitaldreamFat.woff2') format('woff2'),
        url('https://semicon.github.io/fonts/DigitaldreamFat.woff') format('woff');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    * {
      margin: 0px;
      padding: 0px;
      box-sizing: border-box;
      font-family: 'K2D', sans-serif;
    }

    body {
      font-family: 'Kanit', sans-serif;
      color: #444;
      background-color: white;
      padding: 20px;
      border: 2px solid white;
      box-shadow: 0px 8px 10px rgba(0, 0, 0, 0.5);
      font-size: 1.05rem;
      min-height: 100vh;
      display: grid;
      place-items: center;
      background-color: #92a8d1;
      background: url("https://www.i-pic.info/i/BbiN536436.jpg") no-repeat center center fixed;
      -webkit-background-size: cover;
      -moz-background-size: cover;
      -o-background-size: cover;
      background-size: cover;
    }

    .wrapper {
      background: rgba(221, 255, 255, 0.9);
      width: 380px;
      padding: 20px;
      border: 1px solid #999;
      border-radius: 10px;
      box-shadow: 0px 15px 20px rgba(0, 0, 0, 0.1);
    }

    .site-logo {
      content: url("https://www.huana-nbp.go.th/index/add_file/P0D284NMon35557.png");
      display: inline-block;
      margin-top: 20px;
      width: auto;
      height: 100px;
    }

    .msgBg {
      background-color: transparent;
    }

    input#employee {
      font-family: 'Kanit', sans-serif;
      width: 100%;
      height: 60px;
      background-color: brown;
      color: yellow;
      margin-block-start: 5px;
      border-radius: 36px;
      font-size: 20px;
      text-align: center;
      border: none;
      padding: 0 20px;
    }

    .clock {
      font-family: Digital dream Fat;
      font-size: 28px;
      color: #00f6fa;
      letter-spacing: 3px;
      text-shadow: 1px 1px 2px teal, 0 0 25px green, 0 0 5px #00fbff;
      min-width: 98%;
      background: #444;
      padding: 5px 0px 5px 10px;
      display: inline-block;
      border: 3px solid #ccc;
      border-radius: 2px;
      outline-style: solid;
      outline-color: #999;
    }

    .btn:disabled {
      opacity: 0.6;
    }

    /* Queue Status Styles */
    .queue-status {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .queue-number {
      font-size: 2rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 10px;
    }

    .queue-info {
      text-align: center;
      font-size: 0.9rem;
    }

    .queue-progress {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.3);
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .queue-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 4px;
    }

    .processing-animation {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .queue-timer {
      font-family: 'Digital dream Fat';
      font-size: 1.2rem;
      color: #FFD700;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    .success-animation {
      color: #4CAF50;
      font-weight: bold;
    }

    .error-animation {
      color: #f44336;
      font-weight: bold;
    }

    /* Hidden class */
    .d-none {
      display: none !important;
    }
  </style>
</head>

<body>
  <div class="wrapper text-center">
    <div class="site-logo text-center"></div>
    <h5>ระบบลงเวลาออนไลน์ อบต.ข่าใหญ่</h5>
    <small class="text-muted">ระบบจัดคิวอัตโนมัติ</small>

    <span id="MyClockDisplay" class="clock mt-3" onload="showTime()"></span>

    <form id="myForm">
      <div class="row mt-4">
        <div class="form-group col">
          <label for="employee">พิมพ์ชื่อหรือรหัส</label>
          <input id="employee" class="text-center" autocomplete="off" placeholder="ชื่อ-นามสกุล หรือ รหัสพนักงาน">
        </div>
      </div>

      <div class="row mt-4">
        <div class="form-group col">
          <label for="lblinfo"><i class="fas fa-book-reader"></i> หมายเหตุ:ประชุม/กิจกรรม อื่นๆ</label>
          <input type="search" class="form-control form-control-lg" id="userinfo" name="userinfo" list="list" placeholder="ระบุหมายเหตุ (ถ้ามี)">
          <datalist id="list">
            <option value="ไปราชการ">ไปราชการ</option>
            <option value="ลากิจ">ลากิจ</option>
            <option value="ลาป่วย">ลาป่วย</option>
            <option value="ลาคลอด">ลาคลอด</option>
          </datalist>
        </div>
      </div>

      <div class="row mt-4 g-2">
        <div class="col-6">
          <button id="clockin" type="button" class="btn btn-lg btn-primary w-100">
            <span class="btn-text">Clock In</span>
            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
          </button>
        </div>
        <div class="col-6">
          <button id="clockout" type="button" class="btn btn-lg btn-warning w-100">
            <span class="btn-text">Clock Out</span>
            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
          </button>
        </div>
      </div>

      <!-- Queue Status Display -->
      <div id="queueStatus" class="queue-status d-none">
        <div class="queue-number" id="queueNumber">
          <span class="processing-animation"></span>
          คิวที่ <span id="queuePosition">-</span>
        </div>
        <div class="queue-progress">
          <div class="queue-progress-bar" id="queueProgressBar"></div>
        </div>
        <div class="queue-info">
          <div>เวลารอโดยประมาณ: <span class="queue-timer" id="estimatedTime">--:--</span></div>
          <div id="queueMessage" class="mt-2">กำลังประมวลผล...</div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="form-group col">
          <div class="alert" role="alert" id="message"></div>
        </div>
      </div>
    </form>
  </div>

  <script>
    // Global variables
    var scripturl = 'https://script.google.com/macros/s/AKfycbz1fErVaxzVX-6YFD7Q7X_EfwkApE4G8PdPjTK3zqRUbj1GVeFXyuQMFOCr-1_V022c/exec';
    var owner = 'องค์การบริหารส่วนตำบลข่าใหญ่';
    var profile = null;
    var gps = null;
    var currentQueueId = null;
    var queueCheckInterval = null;
    var timerInterval = null;

    // เริ่มต้นระบบ
    $(document).ready(function () {
      initializeApp();
    });

    async function initializeApp() {
      try {
        showMessage("กำลังโหลดระบบ...", 'alert-info');
        
        // โหลด GPS location
        await getLocation();
        
        // เริ่มต้น LIFF
        await initializeLiff();
        
        // โหลดข้อมูลพนักงาน
        await loadEmployeeData();
        
        // ตั้งค่า event handlers
        setupEventHandlers();
        
        // แสดงข้อความเริ่มต้น
        showMessage(owner, 'msgBg');
        
      } catch (error) {
        console.error('เกิดข้อผิดพลาดในการเริ่มต้นระบบ:', error);
        showMessage('เกิดข้อผิดพลาดในการโหลดระบบ กรุณารีเฟรชหน้าเว็บ', 'alert-danger');
      }
    }

    function setupEventHandlers() {
      $('#clockin').click(() => handleClockAction('clockin'));
      $('#clockout').click(() => handleClockAction('clockout'));
    }

    async function initializeLiff() {
      return new Promise((resolve) => {
        try {
          liff.init({
            liffId: '2000498666-QpjPNOd6',
            withLoginOnExternalBrowser: true
          });

          liff.ready.then(() => {
            profile = liff.getDecodedIDToken();
            if (profile) {
              console.log("Profile loaded:", profile.name);
            }
            resolve();
          }).catch((error) => {
            console.warn('LIFF initialization failed:', error);
            resolve();
          });
        } catch (error) {
          console.warn('LIFF error:', error);
          resolve();
        }
      });
    }

    async function getLocation() {
      return new Promise((resolve) => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              gps = [position.coords.latitude, position.coords.longitude];
              console.log("GPS location obtained:", gps);
              resolve();
            },
            (error) => {
              console.warn('GPS error:', error);
              getLocationFromApi().then(resolve);
            },
            {
              timeout: 10000,
              maximumAge: 300000,
              enableHighAccuracy: false
            }
          );
        } else {
          getLocationFromApi().then(resolve);
        }
      });
    }

    async function getLocationFromApi() {
      try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        gps = [data.latitude, data.longitude];
        console.log("IP-based location:", gps);
      } catch (error) {
        console.warn('Failed to get IP location:', error);
        gps = [13.7563, 100.5018]; // Default Thailand location
      }
    }

    async function loadEmployeeData() {
      try {
        const response = await $.ajax({
          method: "POST",
          url: scripturl,
          data: { opt: 'getdata' },
          timeout: 10000
        });

        if (response) {
          $("#employee").autocomplete({
            maxShowItems: 5,
            source: response,
            delay: 300,
            minLength: 1
          });
        }
      } catch (error) {
        console.warn('Failed to load employee data:', error);
      }
    }

    async function handleClockAction(action) {
      const employee = document.getElementById("employee").value.trim();
      const userinfo = document.getElementById("userinfo").value.trim();

      // ตรวจสอบข้อมูลพื้นฐาน
      if (!employee) {
        showMessage('กรุณาเลือกรายชื่อพนักงาน', 'alert-warning text-danger');
        return;
      }

      if (!gps) {
        showMessage('ไม่พบข้อมูลตำแหน่ง กรุณาอนุญาตการเข้าถึงตำแหน่ง', 'alert-warning');
        return;
      }

      // ปิดการใช้งานปุ่ม
      disableButtons(true);
      
      const actionText = action === 'clockin' ? 'เข้างาน' : 'ออกงาน';
      showMessage(`กำลังเพิ่มเข้าคิวสำหรับลงเวลา${actionText}...`, 'alert-info');

      try {
        const response = await $.ajax({
          method: 'POST',
          url: scripturl,
          data: {
            opt: action,
            employee: employee,
            userinfo: userinfo,
            lat: gps[0],
            lon: gps[1],
            line_name: profile?.name || 'ไม่ทราบชื่อ',
            line_picture: profile?.picture || ''
          },
          timeout: 30000
        });

        handleQueueResponse(response, actionText);

      } catch (error) {
        console.error(`${action} error:`, error);
        if (error.statusText === 'timeout') {
          showMessage('การเชื่อมต่อใช้เวลานานกว่าปกติ กรุณาลองใหม่อีกครั้ง', 'alert-warning');
        } else {
          showMessage('เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง', 'alert-danger');
        }
        disableButtons(false);
      }
    }

    function handleQueueResponse(response, actionText) {
      if (response.msg === 'QUEUED') {
        // เพิ่มเข้าคิวสำเร็จ
        currentQueueId = response.queueId;
        showQueueStatus(response.position, response.estimatedWait);
        showMessage(`เพิ่มเข้าคิวเรียบร้อย - คิวที่ ${response.position}`, 'alert-success');
        startQueueMonitoring();
        
      } else if (response.msg === 'DUPLICATE') {
        // มีคิวอยู่แล้ว
        currentQueueId = response.queueId;
        showQueueStatus(response.position, response.estimatedWait || response.position * 3);
        showMessage(`คุณมีการลงเวลา${actionText}อยู่ในคิวแล้ว`, 'alert-warning');
        startQueueMonitoring();
        
      } else if (response.msg === 'BUSY') {
        showMessage(response.message, 'alert-warning');
        disableButtons(false);
        
      } else {
        showMessage(response.message || 'เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ', 'alert-danger');
        disableButtons(false);
      }
    }

    function showQueueStatus(position, estimatedWait) {
      const queueStatus = document.getElementById('queueStatus');
      const queuePosition = document.getElementById('queuePosition');
      const estimatedTimeEl = document.getElementById('estimatedTime');
      const queueMessage = document.getElementById('queueMessage');

      queuePosition.textContent = position;
      queueStatus.classList.remove('d-none');
      
      if (position === 1) {
        queueMessage.innerHTML = '<span class="processing-animation"></span>กำลังประมวลผล...';
        queueMessage.classList.add('pulse');
      } else {
        queueMessage.textContent = `รอคิวอีก ${position - 1} คน`;
        queueMessage.classList.remove('pulse');
      }

      // แสดงเวลารอ
      if (estimatedWait) {
        startCountdown(estimatedWait);
      }

      // อัพเดท progress bar
      const progressBar = document.getElementById('queueProgressBar');
      const progress = position === 1 ? 90 : Math.max(10, 100 - (position * 10));
      progressBar.style.width = progress + '%';
    }

    function startCountdown(seconds) {
      const estimatedTimeEl = document.getElementById('estimatedTime');
      let remainingTime = seconds;

      if (timerInterval) {
        clearInterval(timerInterval);
      }

      timerInterval = setInterval(() => {
        const minutes = Math.floor(remainingTime / 60);
        const secs = remainingTime % 60;
        estimatedTimeEl.textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        
        if (remainingTime > 0) {
          remainingTime--;
        } else {
          estimatedTimeEl.textContent = '00:00';
          clearInterval(timerInterval);
        }
      }, 1000);
    }

    function startQueueMonitoring() {
      if (queueCheckInterval) {
        clearInterval(queueCheckInterval);
      }

      queueCheckInterval = setInterval(async () => {
        if (!currentQueueId) {
          clearInterval(queueCheckInterval);
          return;
        }

        try {
          const response = await $.ajax({
            method: 'POST',
            url: scripturl,
            data: {
              opt: 'checkqueue',
              queueId: currentQueueId
            },
            timeout: 10000
          });

          handleQueueUpdate(response);

        } catch (error) {
          console.warn('Queue check failed:', error);
        }
      }, 3000); // ตรวจสอบทุก 3 วินาที
    }

    function handleQueueUpdate(response) {
      if (response.msg === 'NOT_FOUND') {
        // ประมวลผลเสร็จแล้ว
        hideQueueStatus();
        showMessage('ประมวลผลเสร็จเรียบร้อย', 'alert-success');
        disableButtons(false);
        clearForm();
        currentQueueId = null;
        
      } else if (response.msg === 'OK') {
        if (response.status === 'completed' && response.result) {
          // ได้ผลลัพธ์แล้ว
          handleCompletedResult(response.result);
          
        } else if (response.status === 'processing') {
          // กำลังประมวลผล
          updateQueueToProcessing();
          
        } else if (response.status === 'waiting') {
          // ยังรอคิว
          if (response.position) {
            showQueueStatus(response.position, response.estimatedWait);
          }
        }
      }
    }

    function handleCompletedResult(result) {
      hideQueueStatus();
      
      if (result.msg === 'SUCCESS') {
        const message = `${result.employee}<br>${result.message}`;
        showMessage(message, 'alert-success success-animation');
      } else {
        showMessage(`${result.employee} ${result.message}`, 'alert-warning error-animation');
      }
      
      disableButtons(false);
      clearForm();
      currentQueueId = null;
    }

    function updateQueueToProcessing() {
      const queueMessage = document.getElementById('queueMessage');
      const progressBar = document.getElementById('queueProgressBar');
      
      queueMessage.innerHTML = '<span class="processing-animation"></span>กำลังประมวลผลคำขอของคุณ...';
      queueMessage.classList.add('pulse');
      progressBar.style.width = '95%';
      
      // หยุดการนับถอยหลัง
      if (timerInterval) {
        clearInterval(timerInterval);
        document.getElementById('estimatedTime').textContent = 'กำลังประมวลผล';
      }
    }

    function hideQueueStatus() {
      const queueStatus = document.getElementById('queueStatus');
      queueStatus.classList.add('d-none');
      
      if (queueCheckInterval) {
        clearInterval(queueCheckInterval);
        queueCheckInterval = null;
      }
      
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function disableButtons(disabled) {
      document.getElementById('clockin').disabled = disabled;
      document.getElementById('clockout').disabled = disabled;
      
      const buttons = ['#clockin', '#clockout'];
      buttons.forEach(buttonId => {
        const button = $(buttonId);
        const text = button.find('.btn-text');
        const spinner = button.find('.spinner-border');
        
        if (disabled) {
          text.addClass('d-none');
          spinner.removeClass('d-none');
        } else {
          text.removeClass('d-none');
          spinner.addClass('d-none');
        }
      });
    }

    function showMessage(message, className) {
      const messageElement = document.getElementById('message');
      messageElement.innerHTML = message;
      messageElement.className = `alert ${className}`;
    }

    function clearForm() {
      setTimeout(() => {
        showMessage(owner, 'msgBg');
        document.getElementById("myForm").reset();
      }, 5000);
    }

    // Digital Clock
    function showTime() {
      const date = new Date();
      let h = date.getHours();
      let m = date.getMinutes();
      let s = date.getSeconds();
      
      const dot = s % 2 === 1 ? '.' : '\xa0';
      
      h = h < 10 ? "0" + h : h;
      m = m < 10 ? "0" + m : m;
      s = s < 10 ? "0" + s : s;
      
      const time = h + ":" + m + ":" + s + dot;
      const clockElement = document.getElementById("MyClockDisplay");
      if (clockElement) {
        clockElement.textContent = time;
      }
      
      setTimeout(showTime, 1000);
    }

    // Cleanup เมื่อออกจากหน้า
    window.addEventListener('beforeunload', function() {
      if (queueCheckInterval) {
        clearInterval(queueCheckInterval);
      }
      if (timerInterval) {
        clearInterval(timerInterval);
      }
    });

    // เริ่มนาฬิกา
    showTime();
  </script>
  
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</body>
</html>
